<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéµ Teste do Audio Analyzer - PROD.AI</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            margin: 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background: #252525;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #333;
        }
        .test-btn {
            background: #00d4ff;
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 10px 10px 0;
        }
        .test-btn:hover {
            background: #00a8cc;
        }
        .log {
            background: #1e1e1e;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .success { color: #51cf66; }
        .error { color: #ff6b6b; }
        .info { color: #00d4ff; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Teste do Audio Analyzer - PROD.AI</h1>
        <p>Sistema de an√°lise de √°udio em tempo real usando Web Audio API</p>
        
        <!-- Teste de Carregamento -->
        <div class="test-section">
            <h3>üöÄ Teste de Carregamento</h3>
            <button class="test-btn" onclick="testLoadAnalyzer()">Testar Carregamento</button>
            <button class="test-btn" onclick="checkDependencies()">Verificar Depend√™ncias</button>
            <div id="loadTest" class="log"></div>
        </div>
        
        <!-- Teste de Upload -->
        <div class="test-section">
            <h3>üìÅ Teste de Upload</h3>
            <input type="file" id="testFileInput" accept="audio/*">
            <button class="test-btn" onclick="testFileAnalysis()">Testar An√°lise</button>
            <div id="uploadTest" class="log"></div>
        </div>
        
        <!-- Teste de Funcionalidades -->
        <div class="test-section">
            <h3>‚öôÔ∏è Teste de Funcionalidades</h3>
            <button class="test-btn" onclick="testAudioContext()">Testar Audio Context</button>
            <button class="test-btn" onclick="testFFT()">Testar FFT</button>
            <button class="test-btn" onclick="testPromptGeneration()">Testar Gera√ß√£o de Prompts</button>
            <div id="functionTest" class="log"></div>
        </div>
        
        <!-- Demonstra√ß√£o -->
        <div class="test-section">
            <h3>üéµ Demonstra√ß√£o Completa</h3>
            <button class="test-btn" onclick="runCompleteDemo()">Executar Demo Completa</button>
            <div id="demoTest" class="log"></div>
        </div>
        
        <!-- Status do Sistema -->
        <div class="test-section">
            <h3>üìä Status do Sistema</h3>
            <div id="systemStatus" class="log">Carregando status...</div>
        </div>
    </div>

    <!-- Scripts do Audio Analyzer -->
    <script src="audio-analyzer.js"></script>
    
    <script>
        // üß™ SISTEMA DE TESTES PARA AUDIO ANALYZER
        
        let testResults = {
            analyzer: false,
            audioContext: false,
            fft: false,
            integration: false
        };
        
        // üìä Atualizar status do sistema
        function updateSystemStatus() {
            const status = document.getElementById('systemStatus');
            if (!status) return;
            
            const checks = [
                { name: 'Web Audio API', status: !!(window.AudioContext || window.webkitAudioContext), critical: true },
                { name: 'Audio Analyzer', status: !!window.audioAnalyzer, critical: true },
                { name: 'File API', status: !!(window.File && window.FileReader), critical: true },
                { name: 'Navigator', status: !!navigator, critical: false },
                { name: 'Clipboard API', status: !!(navigator.clipboard), critical: false },
                { name: 'Local Storage', status: typeof(Storage) !== "undefined", critical: false }
            ];
            
            let statusHTML = '';
            checks.forEach(check => {
                const icon = check.status ? '‚úÖ' : '‚ùå';
                const className = check.status ? 'success' : 'error';
                const critical = check.critical ? ' (CR√çTICO)' : '';
                statusHTML += `<span class="${className}">${icon} ${check.name}${critical}</span>\n`;
            });
            
            status.innerHTML = statusHTML;
        }
        
        // üß™ Fun√ß√£o de log para testes
        function logTest(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            if (!element) return;
            
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            element.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            element.scrollTop = element.scrollHeight;
        }
        
        // üöÄ Testar carregamento do analyzer
        async function testLoadAnalyzer() {
            const log = (msg, type) => logTest('loadTest', msg, type);
            
            log('Iniciando teste de carregamento...', 'info');
            
            try {
                if (window.audioAnalyzer) {
                    log('‚úÖ Audio Analyzer j√° carregado', 'success');
                    testResults.analyzer = true;
                } else {
                    log('‚ùå Audio Analyzer n√£o encontrado', 'error');
                    testResults.analyzer = false;
                    return;
                }
                
                // Testar inicializa√ß√£o
                const initialized = await window.audioAnalyzer.initializeAnalyzer();
                if (initialized) {
                    log('‚úÖ Audio Analyzer inicializado com sucesso', 'success');
                } else {
                    log('‚ùå Falha na inicializa√ß√£o', 'error');
                }
                
            } catch (error) {
                log(`‚ùå Erro no teste: ${error.message}`, 'error');
            }
        }
        
        // üîç Verificar depend√™ncias
        function checkDependencies() {
            const log = (msg, type) => logTest('loadTest', msg, type);
            
            log('Verificando depend√™ncias...', 'info');
            
            const deps = {
                'AudioContext': !!(window.AudioContext || window.webkitAudioContext),
                'File API': !!(window.File && window.FileReader && window.FileList && window.Blob),
                'URL API': !!window.URL,
                'Promise': typeof Promise !== 'undefined',
                'Async/Await': (function() {
                    try {
                        eval('async function test() {}');
                        return true;
                    } catch (e) {
                        return false;
                    }
                })()
            };
            
            Object.entries(deps).forEach(([name, available]) => {
                const status = available ? '‚úÖ' : '‚ùå';
                const type = available ? 'success' : 'error';
                log(`${status} ${name}`, type);
            });
        }
        
        // üìÅ Testar an√°lise de arquivo
        async function testFileAnalysis() {
            const log = (msg, type) => logTest('uploadTest', msg, type);
            const fileInput = document.getElementById('testFileInput');
            
            if (!fileInput.files.length) {
                log('‚ùå Por favor, selecione um arquivo de √°udio', 'error');
                return;
            }
            
            const file = fileInput.files[0];
            log(`Analisando arquivo: ${file.name} (${(file.size/1024/1024).toFixed(2)}MB)`, 'info');
            
            try {
                if (!window.audioAnalyzer) {
                    log('‚ùå Audio Analyzer n√£o carregado', 'error');
                    return;
                }
                
                log('Iniciando an√°lise...', 'info');
                const analysis = await window.audioAnalyzer.analyzeAudioFile(file);
                
                log('‚úÖ An√°lise conclu√≠da!', 'success');
                log(`üìä Peak: ${analysis.technicalData.peak.toFixed(1)}dB`, 'info');
                log(`üìä RMS: ${analysis.technicalData.rms.toFixed(1)}dB`, 'info');
                log(`üìä Dura√ß√£o: ${analysis.duration.toFixed(1)}s`, 'info');
                log(`üìä Problemas: ${analysis.problems.length}`, 'info');
                log(`üìä Sugest√µes: ${analysis.suggestions.length}`, 'info');
                
                // Testar gera√ß√£o de prompt
                const prompt = window.audioAnalyzer.generateAIPrompt(analysis);
                log(`üìù Prompt gerado: ${prompt.length} caracteres`, 'success');
                
            } catch (error) {
                log(`‚ùå Erro na an√°lise: ${error.message}`, 'error');
            }
        }
        
        // üéµ Testar Audio Context
        async function testAudioContext() {
            const log = (msg, type) => logTest('functionTest', msg, type);
            
            try {
                log('Testando Audio Context...', 'info');
                
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                if (!AudioContextClass) {
                    log('‚ùå Audio Context n√£o suportado', 'error');
                    return;
                }
                
                const ctx = new AudioContextClass();
                log(`‚úÖ Audio Context criado - Sample Rate: ${ctx.sampleRate}Hz`, 'success');
                
                const analyzer = ctx.createAnalyser();
                analyzer.fftSize = 2048;
                log(`‚úÖ Analyzer Node criado - FFT Size: ${analyzer.fftSize}`, 'success');
                
                ctx.close();
                log('‚úÖ Audio Context fechado corretamente', 'success');
                
                testResults.audioContext = true;
                
            } catch (error) {
                log(`‚ùå Erro no Audio Context: ${error.message}`, 'error');
                testResults.audioContext = false;
            }
        }
        
        // üìä Testar FFT
        function testFFT() {
            const log = (msg, type) => logTest('functionTest', msg, type);
            
            try {
                log('Testando implementa√ß√£o FFT...', 'info');
                
                if (!window.audioAnalyzer) {
                    log('‚ùå Audio Analyzer n√£o carregado', 'error');
                    return;
                }
                
                // Gerar sinal de teste
                const testSignal = new Array(1024);
                for (let i = 0; i < testSignal.length; i++) {
                    testSignal[i] = Math.sin(2 * Math.PI * 440 * i / 44100); // 440Hz
                }
                
                log('‚úÖ Sinal de teste gerado (440Hz)', 'info');
                
                // Testar FFT
                const spectrum = window.audioAnalyzer.simpleFFT(testSignal);
                log(`‚úÖ FFT executada - ${spectrum.length} bins`, 'success');
                
                // Encontrar pico
                let maxBin = 0;
                let maxValue = 0;
                for (let i = 1; i < spectrum.length / 2; i++) {
                    if (spectrum[i] > maxValue) {
                        maxValue = spectrum[i];
                        maxBin = i;
                    }
                }
                
                const detectedFreq = (maxBin * 44100) / 1024;
                log(`üéØ Frequ√™ncia detectada: ${detectedFreq.toFixed(1)}Hz`, 'success');
                
                testResults.fft = true;
                
            } catch (error) {
                log(`‚ùå Erro no teste FFT: ${error.message}`, 'error');
                testResults.fft = false;
            }
        }
        
        // üìù Testar gera√ß√£o de prompts
        function testPromptGeneration() {
            const log = (msg, type) => logTest('functionTest', msg, type);
            
            try {
                log('Testando gera√ß√£o de prompts...', 'info');
                
                if (!window.audioAnalyzer) {
                    log('‚ùå Audio Analyzer n√£o carregado', 'error');
                    return;
                }
                
                // Criar an√°lise de exemplo
                const mockAnalysis = {
                    duration: 180.5,
                    sampleRate: 44100,
                    channels: 2,
                    technicalData: {
                        peak: -2.1,
                        rms: -14.5,
                        dynamicRange: 12.4,
                        dominantFrequencies: [
                            { frequency: 65, occurrences: 15 },
                            { frequency: 440, occurrences: 8 },
                            { frequency: 8000, occurrences: 5 }
                        ]
                    },
                    problems: [
                        {
                            type: 'test_problem',
                            message: 'Problema de teste',
                            solution: 'Solu√ß√£o de teste',
                            severity: 'medium'
                        }
                    ],
                    suggestions: [
                        {
                            type: 'test_suggestion',
                            message: 'Sugest√£o de teste',
                            action: 'A√ß√£o de teste'
                        }
                    ]
                };
                
                log('‚úÖ An√°lise mock criada', 'info');
                
                const prompt = window.audioAnalyzer.generateAIPrompt(mockAnalysis);
                
                log(`‚úÖ Prompt gerado com sucesso!`, 'success');
                log(`üìù Tamanho: ${prompt.length} caracteres`, 'info');
                log(`üìä Cont√©m dados t√©cnicos: ${prompt.includes('DADOS T√âCNICOS') ? '‚úÖ' : '‚ùå'}`, 'info');
                log(`üö® Cont√©m problemas: ${prompt.includes('PROBLEMAS DETECTADOS') ? '‚úÖ' : '‚ùå'}`, 'info');
                log(`üí° Cont√©m sugest√µes: ${prompt.includes('SUGEST√ïES AUTOM√ÅTICAS') ? '‚úÖ' : '‚ùå'}`, 'info');
                
                log('üìÑ Preview do prompt:', 'info');
                log(prompt.substring(0, 200) + '...', 'info');
                
            } catch (error) {
                log(`‚ùå Erro na gera√ß√£o de prompt: ${error.message}`, 'error');
            }
        }
        
        // üé≠ Demo completa
        async function runCompleteDemo() {
            const log = (msg, type) => logTest('demoTest', msg, type);
            
            log('üé¨ Iniciando demonstra√ß√£o completa...', 'info');
            log('', 'info');
            
            try {
                // Passo 1: Verificar sistema
                log('1Ô∏è‚É£ Verificando sistema...', 'info');
                await new Promise(resolve => setTimeout(resolve, 500));
                
                if (!window.audioAnalyzer) {
                    log('‚ùå Sistema n√£o carregado corretamente', 'error');
                    return;
                }
                log('‚úÖ Sistema operacional', 'success');
                
                // Passo 2: Inicializar
                log('2Ô∏è‚É£ Inicializando Audio Analyzer...', 'info');
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const initialized = await window.audioAnalyzer.initializeAnalyzer();
                if (!initialized) {
                    log('‚ùå Falha na inicializa√ß√£o', 'error');
                    return;
                }
                log('‚úÖ Audio Analyzer inicializado', 'success');
                
                // Passo 3: Simular an√°lise
                log('3Ô∏è‚É£ Simulando an√°lise de √°udio...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Criar dados simulados mais realistas
                const simulatedAnalysis = {
                    duration: 210.7,
                    sampleRate: 44100,
                    channels: 2,
                    technicalData: {
                        peak: -1.2,
                        rms: -12.8,
                        dynamicRange: 11.6,
                        dominantFrequencies: [
                            { frequency: 60, occurrences: 22 },    // Sub bass
                            { frequency: 440, occurrences: 18 },   // A4 note
                            { frequency: 1000, occurrences: 12 },  // Mid frequency
                            { frequency: 5000, occurrences: 8 },   // Presence
                            { frequency: 10000, occurrences: 5 }   // Air
                        ]
                    },
                    problems: [
                        {
                            type: 'slight_clipping',
                            message: 'Poss√≠vel clipping detectado em picos',
                            solution: 'Reduzir gain em 2-3dB ou usar limitador suave',
                            severity: 'low'
                        }
                    ],
                    suggestions: [
                        {
                            type: 'mastering',
                            message: 'N√≠vel adequado para streaming',
                            action: 'Volume ideal para Spotify/YouTube (-14 LUFS)'
                        },
                        {
                            type: 'frequency_balance',
                            message: 'Boa distribui√ß√£o de frequ√™ncias',
                            action: 'Considere leve boost em 10kHz para mais brilho'
                        }
                    ]
                };
                
                log('‚úÖ An√°lise simulada conclu√≠da!', 'success');
                log('', 'info');
                
                // Passo 4: Mostrar resultados
                log('4Ô∏è‚É£ Resultados da an√°lise:', 'info');
                log(`üéµ Dura√ß√£o: ${simulatedAnalysis.duration}s`, 'info');
                log(`üìä Peak: ${simulatedAnalysis.technicalData.peak}dB`, 'info');
                log(`üìä RMS: ${simulatedAnalysis.technicalData.rms}dB (ideal para streaming!)`, 'success');
                log(`üìä Din√¢mica: ${simulatedAnalysis.technicalData.dynamicRange}dB`, 'info');
                log(`üéØ Frequ√™ncias dominantes: ${simulatedAnalysis.technicalData.dominantFrequencies.length}`, 'info');
                log(`üö® Problemas detectados: ${simulatedAnalysis.problems.length}`, 'info');
                log(`üí° Sugest√µes: ${simulatedAnalysis.suggestions.length}`, 'success');
                log('', 'info');
                
                // Passo 5: Gerar prompt para IA
                log('5Ô∏è‚É£ Gerando prompt para IA...', 'info');
                await new Promise(resolve => setTimeout(resolve, 800));
                
                const aiPrompt = window.audioAnalyzer.generateAIPrompt(simulatedAnalysis);
                log('‚úÖ Prompt gerado para envio ao chat!', 'success');
                log(`üìù Tamanho: ${aiPrompt.length} caracteres`, 'info');
                log('', 'info');
                
                // Passo 6: Finalizar
                log('6Ô∏è‚É£ Demo conclu√≠da com sucesso! üéâ', 'success');
                log('', 'info');
                log('üíª O sistema est√° pronto para usar!', 'success');
                log('üéµ Fa√ßa upload de um arquivo de √°udio para testar na pr√°tica.', 'info');
                
                testResults.integration = true;
                
            } catch (error) {
                log(`‚ùå Erro na demonstra√ß√£o: ${error.message}`, 'error');
                testResults.integration = false;
            }
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            updateSystemStatus();
            
            // Verificar periodicamente o status
            setInterval(updateSystemStatus, 2000);
        });
        
        console.log('üß™ Sistema de Testes do Audio Analyzer carregado!');
    </script>
</body>
</html>
