<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üöÄ Audio Analyzer V2 - FASE 2 Advanced Demo</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a, #1a1a2e, #16213e);
            color: white;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        .title {
            font-size: 3rem;
            background: linear-gradient(45deg, #00d4ff, #b066ff, #00ff88);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }
        .subtitle {
            font-size: 1.2rem;
            color: #888;
            margin-bottom: 30px;
        }
        .demo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .demo-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        .demo-card:hover {
            transform: translateY(-5px);
            border-color: #00d4ff;
            box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
        }
        .demo-title {
            font-size: 1.4rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .demo-description {
            color: #ccc;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        .demo-btn {
            background: linear-gradient(45deg, #00d4ff, #0099cc);
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            font-size: 1rem;
        }
        .demo-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
        }
        .demo-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .log-container {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
        }
        .log-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .log-content {
            background: #000;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            line-height: 1.4;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-ready { background: #00ff88; }
        .status-processing { background: #00d4ff; animation: pulse 1s infinite; }
        .status-error { background: #ff4757; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .preset-demo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .preset-card {
            background: rgba(255, 255, 255, 0.03);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        .preset-card:hover {
            border-color: #b066ff;
            background: rgba(176, 102, 255, 0.1);
        }
        .preset-card.active {
            border-color: #00ff88;
            background: rgba(0, 255, 136, 0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">üöÄ FASE 2: Advanced Features</h1>
            <p class="subtitle">
                Demonstra√ß√£o das funcionalidades avan√ßadas do Audio Analyzer V2
                <br>
                <span class="status-indicator status-ready"></span>
                Sistema V2 carregado e pronto para testes
            </p>
        </div>

        <div class="demo-grid">
            <div class="demo-card">
                <div class="demo-title">
                    üéõÔ∏è Sistema de Presets
                </div>
                <div class="demo-description">
                    An√°lise otimizada para diferentes estilos musicais com configura√ß√µes personalizadas para cada g√™nero.
                </div>
                <button class="demo-btn" onclick="demoPresets()">
                    Testar Presets
                </button>
                <div class="preset-demo" id="presetDemo" style="display: none;">
                    <div class="preset-card" data-preset="electronic">üéß Electronic</div>
                    <div class="preset-card" data-preset="rock">üé∏ Rock</div>
                    <div class="preset-card" data-preset="classical">üéº Classical</div>
                    <div class="preset-card" data-preset="jazz">üé∫ Jazz</div>
                    <div class="preset-card" data-preset="vocal">üé§ Vocal</div>
                </div>
            </div>

            <div class="demo-card">
                <div class="demo-title">
                    üåà Visualiza√ß√µes Avan√ßadas
                </div>
                <div class="demo-description">
                    Espectrogramas em tempo real, an√°lise de formas de onda e visualiza√ß√£o de features com Web Workers.
                </div>
                <button class="demo-btn" onclick="demoVisualizations()">
                    Demo Visualiza√ß√µes
                </button>
            </div>

            <div class="demo-card">
                <div class="demo-title">
                    üìä Relat√≥rios Detalhados
                </div>
                <div class="demo-description">
                    Gera√ß√£o de relat√≥rios completos com recomenda√ß√µes, an√°lise t√©cnica e exporta√ß√£o em m√∫ltiplos formatos.
                </div>
                <button class="demo-btn" onclick="demoReports()">
                    Gerar Relat√≥rio Demo
                </button>
            </div>

            <div class="demo-card">
                <div class="demo-title">
                    ‚ö° Web Workers
                </div>
                <div class="demo-description">
                    Processamento paralelo para an√°lises pesadas sem travamento da interface do usu√°rio.
                </div>
                <button class="demo-btn" onclick="demoWebWorkers()">
                    Testar Web Workers
                </button>
            </div>

            <div class="demo-card">
                <div class="demo-title">
                    üéµ Tempo Real
                </div>
                <div class="demo-description">
                    An√°lise de √°udio em tempo real com visualiza√ß√£o de espectro e detec√ß√£o de caracter√≠sticas ao vivo.
                </div>
                <button class="demo-btn" onclick="demoRealTime()">
                    An√°lise Tempo Real
                </button>
            </div>

            <div class="demo-card">
                <div class="demo-title">
                    üìà Hist√≥rico & Analytics
                </div>
                <div class="demo-description">
                    Sistema de hist√≥rico de an√°lises com compara√ß√£o de resultados e analytics de uso.
                </div>
                <button class="demo-btn" onclick="demoHistory()">
                    Ver Hist√≥rico
                </button>
            </div>
        </div>

        <div class="log-container">
            <div class="log-title">
                üì° Console de Sistema
            </div>
            <div class="log-content" id="systemLog">Sistema inicializado. Aguardando comandos...\n</div>
        </div>
    </div>

    <!-- Load V2 Advanced System -->
    <script src="audio-analyzer-v2-config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/meyda@5.5.1/dist/web/meyda.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/zod@3.22.4/lib/index.umd.js"></script>
    <script src="audio-analyzer-v2.js"></script>
    <script src="audio-analyzer-v2-advanced.js"></script>
    <script src="audio-analyzer-v2-integration.js"></script>

    <script>
        let advancedAnalyzer = null;
        let systemLog = document.getElementById('systemLog');
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : 'üì°';
            systemLog.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            systemLog.scrollTop = systemLog.scrollHeight;
        }
        
        // Initialize system
        setTimeout(() => {
            try {
                if (typeof window.AudioAnalyzerV2Advanced !== 'undefined') {
                    advancedAnalyzer = new window.AudioAnalyzerV2Advanced();
                    log('Sistema V2 Advanced carregado com sucesso', 'success');
                    log(`Presets dispon√≠veis: ${advancedAnalyzer.getPresetsList().map(p => p.name).join(', ')}`);
                    log('Web Workers: ' + (advancedAnalyzer.webWorker ? 'Ativo' : 'Fallback main thread'));
                } else {
                    log('AudioAnalyzerV2Advanced n√£o encontrado', 'error');
                }
            } catch (error) {
                log(`Erro na inicializa√ß√£o: ${error.message}`, 'error');
            }
        }, 2000);
        
        function demoPresets() {
            log('Iniciando demo de presets...');
            const presetDemo = document.getElementById('presetDemo');
            presetDemo.style.display = presetDemo.style.display === 'none' ? 'grid' : 'none';
            
            if (presetDemo.style.display === 'grid' && advancedAnalyzer) {
                const presets = advancedAnalyzer.getPresetsList();
                log(`üìã ${presets.length} presets carregados:`);
                presets.forEach(preset => {
                    log(`  ‚Ä¢ ${preset.name}: ${preset.description}`);
                });
            }
            
            // Setup preset selection
            document.querySelectorAll('.preset-card').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.preset-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    
                    const presetId = card.dataset.preset;
                    log(`üéØ Preset selecionado: ${presetId}`, 'success');
                    
                    if (advancedAnalyzer) {
                        const preset = advancedAnalyzer.presets[presetId];
                        if (preset) {
                            log(`üìä Features: ${preset.features.join(', ')}`);
                            log(`‚öñÔ∏è Pesos: Bass=${preset.weights.bass}, Mid=${preset.weights.mid}, Treble=${preset.weights.treble}`);
                        }
                    }
                });
            });
        }
        
        function demoVisualizations() {
            log('üåà Iniciando demo de visualiza√ß√µes...');
            
            if (!advancedAnalyzer) {
                log('Sistema avan√ßado n√£o dispon√≠vel', 'error');
                return;
            }
            
            // Create demo canvas
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 300;
            canvas.style.width = '100%';
            canvas.style.maxWidth = '800px';
            canvas.style.background = 'rgba(0, 0, 0, 0.5)';
            canvas.style.borderRadius = '10px';
            canvas.style.marginTop = '20px';
            
            // Remove existing canvas
            const existingCanvas = document.querySelector('.demo-canvas');
            if (existingCanvas) existingCanvas.remove();
            
            canvas.classList.add('demo-canvas');
            document.querySelector('.container').appendChild(canvas);
            
            // Demo visualization
            const ctx = canvas.getContext('2d');
            const visualizer = advancedAnalyzer.visualizations.get('spectrum');
            
            if (visualizer) {
                visualizer.initialize(canvas);
                
                // Generate demo data
                const demoData = {
                    frequencies: Array.from({length: 100}, (_, i) => i * 220),
                    amplitudes: Array.from({length: 100}, () => Math.random() * 0.8 + 0.1),
                    peaks: [
                        {frequency: 440, amplitude: 0.9},
                        {frequency: 880, amplitude: 0.7},
                        {frequency: 1320, amplitude: 0.5}
                    ]
                };
                
                visualizer.update(demoData);
                log('‚ú® Visualiza√ß√£o de espectro ativa', 'success');
                
                // Animate
                let frame = 0;
                const animate = () => {
                    frame++;
                    demoData.amplitudes = demoData.amplitudes.map((_, i) => 
                        Math.sin(frame * 0.05 + i * 0.1) * 0.4 + 0.5
                    );
                    visualizer.update(demoData);
                    
                    if (frame < 200) {
                        requestAnimationFrame(animate);
                    }
                };
                animate();
                
            } else {
                log('Visualizador n√£o dispon√≠vel', 'warning');
            }
        }
        
        async function demoReports() {
            log('üìä Gerando relat√≥rio demo...');
            
            if (!advancedAnalyzer) {
                log('Sistema avan√ßado n√£o dispon√≠vel', 'error');
                return;
            }
            
            // Mock analysis data
            const mockAnalysis = {
                preset: 'Electronic/EDM',
                score: 85.3,
                features: {
                    spectralCentroid: 0.72,
                    spectralRolloff: 0.68,
                    energy: 0.91,
                    loudness: -12.5
                },
                classification: {
                    genre: 'Electronic',
                    energy: 'High',
                    mood: 'Energetic'
                },
                recommendations: [
                    'Excellent energy levels for electronic music',
                    'Consider slight EQ boost in mid frequencies',
                    'Dynamic range could be improved'
                ]
            };
            
            try {
                const report = await advancedAnalyzer.generateReport(mockAnalysis);
                log('‚úÖ Relat√≥rio gerado com sucesso', 'success');
                log(`üìÑ Timestamp: ${new Date(report.timestamp).toLocaleString()}`);
                log(`üéØ Score geral: ${mockAnalysis.score}%`);
                log(`üéº G√™nero detectado: ${mockAnalysis.classification.genre}`);
                log(`üí° ${mockAnalysis.recommendations.length} recomenda√ß√µes inclu√≠das`);
                
                // Demo export
                setTimeout(() => {
                    log('üì§ Iniciando exporta√ß√£o JSON...');
                    advancedAnalyzer.exportReport(mockAnalysis, 'json');
                    log('‚úÖ Relat√≥rio exportado como JSON', 'success');
                }, 1000);
                
            } catch (error) {
                log(`Erro ao gerar relat√≥rio: ${error.message}`, 'error');
            }
        }
        
        function demoWebWorkers() {
            log('‚ö° Testando Web Workers...');
            
            if (!advancedAnalyzer) {
                log('Sistema avan√ßado n√£o dispon√≠vel', 'error');
                return;
            }
            
            if (advancedAnalyzer.webWorker) {
                log('‚úÖ Web Worker ativo - testando processamento paralelo', 'success');
                
                // Generate test audio data
                const testData = new Float32Array(4096);
                for (let i = 0; i < testData.length; i++) {
                    testData[i] = Math.sin(2 * Math.PI * 440 * i / 44100) * 0.5;
                }
                
                log('üì§ Enviando dados para Web Worker...');
                
                advancedAnalyzer.webWorker.postMessage({
                    type: 'ANALYZE_SPECTRUM',
                    data: testData
                });
                
                log('‚è≥ Aguardando processamento no Web Worker...');
                
            } else {
                log('‚ö†Ô∏è Web Worker n√£o dispon√≠vel - usando main thread', 'warning');
                log('üí° Algumas funcionalidades avan√ßadas podem ser mais lentas');
            }
        }
        
        function demoRealTime() {
            log('üéµ Iniciando an√°lise em tempo real...');
            
            if (!advancedAnalyzer) {
                log('Sistema avan√ßado n√£o dispon√≠vel', 'error');
                return;
            }
            
            // Request microphone access
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    log('‚úÖ Microfone acessado com sucesso', 'success');
                    log('üéôÔ∏è Iniciando captura de √°udio em tempo real...');
                    
                    // Create audio context
                    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaStreamSource(stream);
                    const analyser = audioContext.createAnalyser();
                    
                    source.connect(analyser);
                    analyser.fftSize = 2048;
                    
                    const bufferLength = analyser.frequencyBinCount;
                    const dataArray = new Uint8Array(bufferLength);
                    
                    let frameCount = 0;
                    const maxFrames = 300; // 5 seconds at ~60fps
                    
                    const analyze = () => {
                        if (frameCount >= maxFrames) {
                            stream.getTracks().forEach(track => track.stop());
                            audioContext.close();
                            log('üõë An√°lise em tempo real finalizada', 'success');
                            return;
                        }
                        
                        analyser.getByteFrequencyData(dataArray);
                        
                        // Calculate real-time metrics
                        const energy = Array.from(dataArray).reduce((sum, val) => sum + val, 0) / dataArray.length;
                        const peak = Math.max(...dataArray);
                        
                        if (frameCount % 30 === 0) { // Log every 0.5 seconds
                            log(`üìä Frame ${frameCount}: Energy=${energy.toFixed(1)}, Peak=${peak}`);
                        }
                        
                        frameCount++;
                        requestAnimationFrame(analyze);
                    };
                    
                    analyze();
                    
                })
                .catch(error => {
                    log(`‚ùå Erro ao acessar microfone: ${error.message}`, 'error');
                    log('üí° Simulando an√°lise em tempo real...');
                    
                    // Fallback simulation
                    let frame = 0;
                    const simulate = () => {
                        if (frame >= 100) return;
                        
                        const energy = Math.sin(frame * 0.1) * 50 + 100;
                        const peak = Math.random() * 255;
                        
                        if (frame % 20 === 0) {
                            log(`üìä Simula√ß√£o Frame ${frame}: Energy=${energy.toFixed(1)}, Peak=${peak.toFixed(1)}`);
                        }
                        
                        frame++;
                        setTimeout(() => requestAnimationFrame(simulate), 50);
                    };
                    
                    simulate();
                });
        }
        
        function demoHistory() {
            log('üìà Verificando hist√≥rico de an√°lises...');
            
            if (!advancedAnalyzer) {
                log('Sistema avan√ßado n√£o dispon√≠vel', 'error');
                return;
            }
            
            const history = advancedAnalyzer.getAnalysisHistory();
            log(`üìö ${history.length} an√°lises no hist√≥rico atual`);
            
            if (history.length === 0) {
                log('‚ûï Adicionando dados demo ao hist√≥rico...');
                
                // Add demo history
                const demoEntries = [
                    {
                        timestamp: Date.now() - 3600000,
                        preset: 'electronic',
                        filename: 'demo-track-1.mp3',
                        analysis: { score: 87.5, genre: 'Electronic' }
                    },
                    {
                        timestamp: Date.now() - 7200000,
                        preset: 'rock',
                        filename: 'demo-track-2.wav',
                        analysis: { score: 92.1, genre: 'Rock' }
                    },
                    {
                        timestamp: Date.now() - 10800000,
                        preset: 'classical',
                        filename: 'demo-track-3.flac',
                        analysis: { score: 95.7, genre: 'Classical' }
                    }
                ];
                
                demoEntries.forEach(entry => {
                    advancedAnalyzer.analysisHistory.push(entry);
                });
                
                log('‚úÖ Hist√≥rico demo adicionado', 'success');
            }
            
            const updatedHistory = advancedAnalyzer.getAnalysisHistory();
            log(`üìä Hist√≥rico atual: ${updatedHistory.length} entradas`);
            
            updatedHistory.forEach((entry, index) => {
                const date = new Date(entry.timestamp).toLocaleString();
                log(`  ${index + 1}. ${entry.filename} (${entry.preset}) - Score: ${entry.analysis.score}% - ${date}`);
            });
            
            // Demo clear history
            setTimeout(() => {
                log('üóëÔ∏è Demonstrando limpeza de hist√≥rico...');
                advancedAnalyzer.clearHistory();
                log('‚úÖ Hist√≥rico limpo', 'success');
            }, 5000);
        }
        
        // Demo worker messages
        setTimeout(() => {
            if (advancedAnalyzer?.webWorker) {
                advancedAnalyzer.webWorker.addEventListener('message', (event) => {
                    const { type, result, features, report } = event.data;
                    
                    switch (type) {
                        case 'SPECTRUM_ANALYZED':
                            log(`üî¨ Espectro analisado: ${result.peaks.length} picos detectados`, 'success');
                            break;
                        case 'FEATURES_CALCULATED':
                            log(`üìä Features calculadas: ${Object.keys(features).join(', ')}`, 'success');
                            break;
                        case 'REPORT_GENERATED':
                            log(`üìÑ Relat√≥rio gerado: Score ${report.summary.overallQuality}%`, 'success');
                            break;
                    }
                });
            }
        }, 3000);
    </script>
</body>
</html>
