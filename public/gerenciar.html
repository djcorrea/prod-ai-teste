<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Conta - PROD.AI</title>
    <link rel="stylesheet" href="gerenciar.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="page-title">Gerenciar conta</h1>
            
            <div class="plan-status" id="plan-status">
                <div class="plan-info">
                    <span class="plan-label">Plano atual:</span>
                    <span class="plan-type plus" id="plan-type">
                        <span class="plan-name">PLUS</span>
                        <span class="plan-icon">‚úÖ</span>
                    </span>
                </div>
            </div>
            
            <button class="btn-back-simple" id="back-to-chat-simple">
                <span class="back-icon">üîô</span>
                Voltar ao chat
            </button>
        </div>

        <div class="form-container">
            <!-- Grid de Cards Principais -->
            <div class="cards-grid">
                <!-- Card: Alterar Senha -->
                <section class="function-card">
                    <div class="card-header">
                        <span class="card-icon">üîí</span>
                        <h3 class="card-title">Alterar Senha</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <div class="input-group">
                                <label for="new-password">Nova senha</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">üîí</span>
                                    <input type="password" id="new-password" placeholder="Digite sua nova senha">
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="confirm-password">Confirmar senha</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">üîí</span>
                                    <input type="password" id="confirm-password" placeholder="Confirme sua nova senha">
                                </div>
                            </div>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-primary" id="update-password-btn">Atualizar senha</button>
                        </div>
                    </div>
                </section>

                <!-- Card: Alterar E-mail -->
                <section class="function-card">
                    <div class="card-header">
                        <span class="card-icon">‚úâÔ∏è</span>
                        <h3 class="card-title">Alterar E-mail</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <div class="input-group">
                                <label for="new-email">Novo e-mail</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">‚úâÔ∏è</span>
                                    <input type="email" id="new-email" placeholder="Digite seu novo e-mail">
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="confirm-email">Confirmar e-mail</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">‚úâÔ∏è</span>
                                    <input type="email" id="confirm-email" placeholder="Confirme seu novo e-mail">
                                </div>
                            </div>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-primary" id="update-email-btn">Atualizar e-mail</button>
                        </div>
                    </div>
                </section>

                <!-- Card: Refazer Entrevista -->
                <section class="function-card">
                    <div class="card-header">
                        <span class="card-icon">‚ôªÔ∏è</span>
                        <h3 class="card-title">Personalizar Novamente</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">Quer mudar suas respostas personalizadas?</p>
                            <p class="card-description">Refa√ßa o processo de configura√ß√£o inicial.</p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-special" id="redo-interview-btn">
                                <span class="btn-icon">‚ôªÔ∏è</span>
                                Personalizar novamente
                            </button>
                            <p class="info-text">Essa funcionalidade √© exclusiva para usu√°rios Plus.</p>
                        </div>
                    </div>
                </section>

                <!-- Card: Fazer Upgrade -->
                <section class="function-card upgrade-card" id="upgrade-card">
                    <div class="card-header">
                        <span class="card-icon">üîì</span>
                        <h3 class="card-title">Upgrade de Plano</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">Voc√™ est√° no plano gratuito. Desbloqueie todo o potencial do PROD.AI</p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-upgrade-premium" id="upgrade-plan-btn">
                                <span class="btn-icon">‚≠ê</span>
                                Fazer Upgrade para Plus
                            </button>
                            <p class="upgrade-benefits">Desbloqueie mensagens ilimitadas e respostas avan√ßadas</p>
                        </div>
                    </div>
                </section>

                <!-- Card: Cancelar Assinatura -->
                <section class="function-card card-perigo">
                    <div class="card-header">
                        <span class="card-icon">‚ùå</span>
                        <h3 class="card-title">Cancelar Assinatura</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">Cancelar sua assinatura atual do plano Plus.</p>
                            <p class="card-description">Voc√™ manter√° acesso at√© o fim do per√≠odo atual.</p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-danger" id="cancel-subscription-btn">
                                <span class="btn-icon">‚ùå</span>
                                Cancelar assinatura
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Card: Excluir Conta -->
                <section class="function-card card-perigo">
                    <div class="card-header">
                        <span class="card-icon">‚ö†Ô∏è</span>
                        <h3 class="card-title">Zona de Perigo</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">
                                <strong>‚ö†Ô∏è Esta a√ß√£o √© irrevers√≠vel!</strong>
                            </p>
                            <p class="card-description">
                                Ao excluir sua conta, todos os dados ser√£o perdidos permanentemente.
                            </p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-delete-account" id="delete-account-btn">
                                <span class="btn-icon">üóëÔ∏è</span>
                                Excluir Conta Permanentemente
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Se√ß√£o de Suporte - Rodap√© -->
        <div class="support-footer-card">
            <h3 class="support-footer-title">
                <span class="support-icon">üí¨</span>
                Suporte
            </h3>
            <p class="support-footer-text">Precisa de ajuda? Entre em contato conosco:</p>
            <div class="support-footer-contact">
                <span class="support-email">prod.ai@gmail.com</span>
            </div>
            <div class="support-footer-info">
                <div class="support-footer-item">
                    <span class="support-item-icon">üìû</span>
                    <span>Suporte telef√¥nico: Seg-Sex, 9h-18h</span>
                </div>
                <div class="support-footer-item">
                    <span class="support-item-icon">üí¨</span>
                    <span>Chat online: 24/7</span>
                </div>
                <div class="support-footer-item">
                    <span class="support-item-icon">‚ö°</span>
                    <span>Resposta em at√© 2 horas</span>
                </div>
            </div>
        </div>
    </div>

    <div class="background-effects">
        <div class="grid-pattern"></div>
        <div class="glow-effect glow-1"></div>
        <div class="glow-effect glow-2"></div>
        <div class="neural-network">
            <div class="neural-node node-1"></div>
            <div class="neural-node node-2"></div>
            <div class="neural-node node-3"></div>
        </div>
    </div>

    <!-- Firebase e Script de Gerenciamento -->
    <script type="module">
        // Aguardar um pouco para garantir que o Firebase carregue
        setTimeout(async () => {
            const { auth } = await import('./firebase.js');
            const { onAuthStateChanged, updatePassword, updateEmail, verifyBeforeUpdateEmail, applyActionCode } = await import('https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js');
            
            console.log('üîß Gerenciar.js carregado');
            
            // Elementos do DOM
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const updatePasswordBtn = document.getElementById('update-password-btn');
            const newEmailInput = document.getElementById('new-email');
            const confirmEmailInput = document.getElementById('confirm-email');
            const updateEmailBtn = document.getElementById('update-email-btn');
            const backToChatBtn = document.getElementById('back-to-chat-simple');
            
            // Verificar se o usu√°rio est√° autenticado
            let currentUser = null;
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    console.log('‚úÖ Usu√°rio autenticado:', user.email);
                    
                    // Atualizar informa√ß√µes do usu√°rio na p√°gina
                    updateUserInfo(user);
                    
                    // Verificar se h√° c√≥digo de verifica√ß√£o na URL
                    checkEmailVerificationCode();
                } else {
                    console.log('‚ùå Usu√°rio n√£o autenticado - redirecionando...');
                    // Redirecionar usu√°rios n√£o autenticados
                    window.location.href = 'login.html';
                }
            });
            
            // Fun√ß√£o para atualizar informa√ß√µes do usu√°rio
            function updateUserInfo(user) {
                // Voc√™ pode expandir isso para mostrar mais informa√ß√µes do usu√°rio
                console.log('üìß Email do usu√°rio:', user.email);
                console.log('üÜî UID do usu√°rio:', user.uid);
            }
            
            // Fun√ß√£o para mostrar mensagens de feedback
            function showMessage(message, type = 'success', cardSelector = '.function-card') {
                // Remove mensagem anterior se existir
                const existingMessage = document.querySelector('.feedback-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                // Criar elemento de mensagem
                const messageDiv = document.createElement('div');
                messageDiv.className = `feedback-message ${type}`;
                messageDiv.textContent = message;
                
                // Determinar qual card adicionar a mensagem
                let targetCard;
                if (cardSelector === 'password') {
                    targetCard = updatePasswordBtn.closest('.function-card');
                } else if (cardSelector === 'email') {
                    targetCard = updateEmailBtn.closest('.function-card');
                } else {
                    targetCard = document.querySelector(cardSelector);
                }
                
                if (targetCard) {
                    targetCard.insertBefore(messageDiv, targetCard.querySelector('.card-body'));
                }
                
                // Auto-remover ap√≥s 5 segundos
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            }
            
            // Fun√ß√£o para validar senha
            function validatePassword(password) {
                if (password.length < 6) {
                    return 'A senha deve ter pelo menos 6 caracteres';
                }
                return null;
            }
            
            // Fun√ß√£o para validar e-mail
            function validateEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    return 'Por favor, insira um e-mail v√°lido';
                }
                return null;
            }
            
            // Fun√ß√£o para verificar c√≥digo de verifica√ß√£o de e-mail na URL
            async function checkEmailVerificationCode() {
                const urlParams = new URLSearchParams(window.location.search);
                const oobCode = urlParams.get('oobCode');
                
                if (oobCode) {
                    console.log('üîç C√≥digo de verifica√ß√£o encontrado na URL');
                    
                    // Recuperar o novo e-mail salvo temporariamente
                    const novoEmailTemp = localStorage.getItem('novoEmailTemp');
                    
                    if (!novoEmailTemp) {
                        console.error('‚ùå Novo e-mail n√£o encontrado no localStorage');
                        showMessage('‚ùå Erro: novo e-mail n√£o encontrado. Tente o processo novamente.', 'error', 'email');
                        
                        // Limpar a URL
                        const newUrl = window.location.origin + window.location.pathname;
                        window.history.replaceState({}, document.title, newUrl);
                        return;
                    }
                    
                    try {
                        // Primeiro aplicar o c√≥digo de verifica√ß√£o
                        await applyActionCode(auth, oobCode);
                        console.log('‚úÖ C√≥digo de verifica√ß√£o aplicado com sucesso');
                        
                        // Aguardar um momento para garantir que o usu√°rio est√° atualizado
                        if (currentUser) {
                            await currentUser.reload();
                        }
                        
                        // Agora sim atualizar o e-mail no Firebase
                        await updateEmail(currentUser, novoEmailTemp);
                        console.log('‚úÖ E-mail atualizado no Firebase');
                        
                        showMessage('‚úÖ E-mail verificado e alterado com sucesso!', 'success', 'email');
                        
                        // Limpar o localStorage
                        localStorage.removeItem('novoEmailTemp');
                        
                        // Limpar a URL removendo os par√¢metros
                        const newUrl = window.location.origin + window.location.pathname;
                        window.history.replaceState({}, document.title, newUrl);
                        
                        // Recarregar o usu√°rio para obter as informa√ß√µes atualizadas
                        if (currentUser) {
                            await currentUser.reload();
                            updateUserInfo(currentUser);
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao confirmar o novo e-mail:', error);
                        
                        let errorMessage = 'Erro ao confirmar o novo e-mail. Tente novamente.';
                        
                        switch (error.code) {
                            case 'auth/expired-action-code':
                                errorMessage = '‚è∞ Link de verifica√ß√£o expirado. Solicite um novo.';
                                break;
                            case 'auth/invalid-action-code':
                                errorMessage = '‚ùå Link de verifica√ß√£o inv√°lido.';
                                break;
                            case 'auth/user-disabled':
                                errorMessage = 'üö´ Conta desabilitada. Entre em contato com o suporte.';
                                break;
                            case 'auth/email-already-in-use':
                                errorMessage = 'üìß Este e-mail j√° est√° sendo usado por outra conta.';
                                break;
                            case 'auth/invalid-email':
                                errorMessage = 'üìß E-mail inv√°lido.';
                                break;
                            default:
                                errorMessage = `‚ùå Erro: ${error.message}`;
                        }
                        
                        showMessage(errorMessage, 'error', 'email');
                        
                        // Limpar o localStorage em caso de erro
                        localStorage.removeItem('novoEmailTemp');
                        
                        // Limpar a URL mesmo em caso de erro
                        const newUrl = window.location.origin + window.location.pathname;
                        window.history.replaceState({}, document.title, newUrl);
                    }
                }
            }
            
            // Fun√ß√£o principal para alterar senha
            async function changePassword() {
                if (!currentUser) {
                    showMessage('Usu√°rio n√£o autenticado. Redirecionando para login...', 'error', 'password');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                const newPassword = newPasswordInput.value.trim();
                const confirmPassword = confirmPasswordInput.value.trim();
                
                // Valida√ß√µes
                if (!newPassword || !confirmPassword) {
                    showMessage('Por favor, preencha todos os campos', 'error', 'password');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showMessage('As senhas n√£o coincidem', 'error', 'password');
                    return;
                }
                
                const passwordError = validatePassword(newPassword);
                if (passwordError) {
                    showMessage(passwordError, 'error', 'password');
                    return;
                }
                
                // Desabilitar bot√£o durante o processo
                updatePasswordBtn.disabled = true;
                updatePasswordBtn.textContent = 'Atualizando...';
                
                try {
                    // Atualizar senha no Firebase
                    await updatePassword(currentUser, newPassword);
                    
                    console.log('‚úÖ Senha atualizada com sucesso');
                    showMessage('‚úÖ Senha atualizada com sucesso!', 'success', 'password');
                    
                    // Limpar campos
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                    
                } catch (error) {
                    console.error('‚ùå Erro ao atualizar senha:', error);
                    
                    // Tratamento de erros espec√≠ficos
                    let errorMessage = 'Erro ao atualizar senha. Tente novamente.';
                    
                    switch (error.code) {
                        case 'auth/requires-recent-login':
                            errorMessage = 'üîí Para alterar a senha, voc√™ precisa fazer login novamente. Redirecionando...';
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 3000);
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'üîê A senha √© muito fraca. Use pelo menos 6 caracteres.';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'üåê Erro de conex√£o. Verifique sua internet e tente novamente.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = '‚è∞ Muitas tentativas. Tente novamente em alguns minutos.';
                            break;
                        default:
                            errorMessage = `‚ùå Erro: ${error.message}`;
                    }
                    
                    showMessage(errorMessage, 'error', 'password');
                } finally {
                    // Reabilitar bot√£o
                    updatePasswordBtn.disabled = false;
                    updatePasswordBtn.textContent = 'Atualizar senha';
                }
            }
            
            // Fun√ß√£o principal para alterar e-mail
            async function changeEmail() {
                if (!currentUser) {
                    showMessage('Usu√°rio n√£o autenticado. Redirecionando para login...', 'error', 'email');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                const newEmail = newEmailInput.value.trim();
                const confirmEmail = confirmEmailInput.value.trim();
                
                // Valida√ß√µes
                if (!newEmail || !confirmEmail) {
                    showMessage('Por favor, preencha todos os campos', 'error', 'email');
                    return;
                }
                
                if (newEmail !== confirmEmail) {
                    showMessage('Os e-mails n√£o coincidem', 'error', 'email');
                    return;
                }
                
                const emailError = validateEmail(newEmail);
                if (emailError) {
                    showMessage(emailError, 'error', 'email');
                    return;
                }
                
                // Verificar se o e-mail √© diferente do atual
                if (newEmail === currentUser.email) {
                    showMessage('O novo e-mail deve ser diferente do atual', 'error', 'email');
                    return;
                }
                
                // Desabilitar bot√£o durante o processo
                updateEmailBtn.disabled = true;
                updateEmailBtn.textContent = 'Enviando verifica√ß√£o...';
                
                try {
                    // PRIMEIRO: Salvar o novo e-mail no localStorage
                    localStorage.setItem('novoEmailTemp', newEmail);
                    console.log('‚úÖ E-mail salvo no localStorage:', newEmail);
                    
                    // SEGUNDO: Usar verifyBeforeUpdateEmail (m√©todo recomendado pelo Firebase)
                    const actionCodeSettings = {
                        url: 'https://prod-ai-teste.vercel.app/gerenciar.html',
                        handleCodeInApp: true
                    };
                    
                    await verifyBeforeUpdateEmail(currentUser, newEmail, actionCodeSettings);
                    
                    console.log('‚úÖ E-mail de verifica√ß√£o enviado');
                    showMessage('üìß E-mail de verifica√ß√£o enviado! Verifique sua caixa de entrada e clique no link para confirmar a altera√ß√£o.', 'success', 'email');
                    
                    // Limpar campos
                    newEmailInput.value = '';
                    confirmEmailInput.value = '';
                    
                } catch (error) {
                    console.error('‚ùå Erro ao enviar verifica√ß√£o de e-mail:', error);
                    
                    // Limpar localStorage em caso de erro
                    localStorage.removeItem('novoEmailTemp');
                    
                    // Tratamento de erros espec√≠ficos
                    let errorMessage = 'Erro ao enviar verifica√ß√£o de e-mail. Tente novamente.';
                    
                    switch (error.code) {
                        case 'auth/requires-recent-login':
                            errorMessage = 'üîí Para alterar o e-mail, voc√™ precisa fazer login novamente. Redirecionando...';
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 3000);
                            break;
                        case 'auth/invalid-email':
                            errorMessage = 'üìß E-mail inv√°lido. Verifique o formato.';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'üåê Erro de conex√£o. Verifique sua internet e tente novamente.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = '‚è∞ Muitas tentativas. Tente novamente em alguns minutos.';
                            break;
                        default:
                            errorMessage = `‚ùå Erro: ${error.message}`;
                    }
                    
                    showMessage(errorMessage, 'error', 'email');
                } finally {
                    // Reabilitar bot√£o
                    updateEmailBtn.disabled = false;
                    updateEmailBtn.textContent = 'Atualizar e-mail';
                }
            }
            
            // Event Listeners
            if (updatePasswordBtn) {
                updatePasswordBtn.addEventListener('click', changePassword);
            }
            
            if (updateEmailBtn) {
                updateEmailBtn.addEventListener('click', changeEmail);
            }
            
            // Permitir Enter nos campos de senha
            if (newPasswordInput) {
                newPasswordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        changePassword();
                    }
                });
            }
            
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        changePassword();
                    }
                });
            }
            
            // Permitir Enter nos campos de e-mail
            if (newEmailInput) {
                newEmailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        changeEmail();
                    }
                });
            }
            
            if (confirmEmailInput) {
                confirmEmailInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        changeEmail();
                    }
                });
            }
            
            // Bot√£o voltar ao chat
            if (backToChatBtn) {
                backToChatBtn.addEventListener('click', function() {
                    window.location.href = 'index.html';
                });
            }
            
            console.log('üîß Event listeners configurados');
        }, 100);
    </script>
</body>
</html>