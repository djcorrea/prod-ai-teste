<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciar Conta - PROD.AI</title>
    <link rel="stylesheet" href="gerenciar.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="page-title">Gerenciar conta</h1>
            
            <div class="plan-status" id="plan-status">
                <div class="plan-info">
                    <span class="plan-label">Plano atual:</span>
                    <span class="plan-type plus" id="plan-type">
                        <span class="plan-name">PLUS</span>
                        <span class="plan-icon">‚úÖ</span>
                    </span>
                </div>
            </div>
            
            <button class="btn-back-simple" id="back-to-chat-simple">
                <span class="back-icon">üîô</span>
                Voltar ao chat
            </button>
        </div>

        <div class="form-container">
            <!-- Grid de Cards Principais -->
            <div class="cards-grid">
                <!-- Card: Alterar Senha -->
                <section class="function-card">
                    <div class="card-header">
                        <span class="card-icon">üîí</span>
                        <h3 class="card-title">Alterar Senha</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <div class="input-group">
                                <label for="new-password">Nova senha</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">üîí</span>
                                    <input type="password" id="new-password" placeholder="Digite sua nova senha">
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="confirm-password">Confirmar senha</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">üîí</span>
                                    <input type="password" id="confirm-password" placeholder="Confirme sua nova senha">
                                </div>
                            </div>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-primary" id="update-password-btn">Atualizar senha</button>
                        </div>
                    </div>
                </section>

                <!-- Card: Alterar E-mail -->
                <section class="function-card">
                    <div class="card-header">
                        <span class="card-icon">‚úâÔ∏è</span>
                        <h3 class="card-title">Alterar E-mail</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <div class="input-group">
                                <label for="new-email">Novo e-mail</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">‚úâÔ∏è</span>
                                    <input type="email" id="new-email" placeholder="Digite seu novo e-mail">
                                </div>
                            </div>
                            <div class="input-group">
                                <label for="confirm-email">Confirmar e-mail</label>
                                <div class="input-wrapper">
                                    <span class="input-icon">‚úâÔ∏è</span>
                                    <input type="email" id="confirm-email" placeholder="Confirme seu novo e-mail">
                                </div>
                            </div>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-primary" id="update-email-btn">Atualizar e-mail</button>
                        </div>
                    </div>
                </section>

                <!-- Card: Refazer Entrevista -->
                <section class="function-card">
                    <div class="card-header">
                        <span class="card-icon">‚ôªÔ∏è</span>
                        <h3 class="card-title">Personalizar Novamente</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">Quer mudar suas respostas personalizadas?</p>
                            <p class="card-description">Refa√ßa o processo de configura√ß√£o inicial.</p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-special" id="redo-interview-btn">
                                <span class="btn-icon">‚ôªÔ∏è</span>
                                Personalizar novamente
                            </button>
                            <p class="info-text">Essa funcionalidade √© exclusiva para usu√°rios Plus.</p>
                        </div>
                    </div>
                </section>

                <!-- Card: Fazer Upgrade -->
                <section class="function-card upgrade-card" id="upgrade-card">
                    <div class="card-header">
                        <span class="card-icon">üîì</span>
                        <h3 class="card-title">Upgrade de Plano</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">Voc√™ est√° no plano gratuito. Desbloqueie todo o potencial do PROD.AI</p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-upgrade-premium" id="upgrade-plan-btn">
                                <span class="btn-icon">‚≠ê</span>
                                Fazer Upgrade para Plus
                            </button>
                            <p class="upgrade-benefits">Desbloqueie mensagens ilimitadas e respostas avan√ßadas</p>
                        </div>
                    </div>
                </section>

                <!-- Card: Cancelar Assinatura -->
                <section class="function-card card-perigo">
                    <div class="card-header">
                        <span class="card-icon">‚ùå</span>
                        <h3 class="card-title">Cancelar Assinatura</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">Cancelar sua assinatura atual do plano Plus.</p>
                            <p class="card-description">Voc√™ manter√° acesso at√© o fim do per√≠odo atual.</p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-danger" id="cancel-subscription-btn">
                                <span class="btn-icon">‚ùå</span>
                                Cancelar assinatura
                            </button>
                        </div>
                    </div>
                </section>

                <!-- Card: Excluir Conta -->
                <section class="function-card card-perigo">
                    <div class="card-header">
                        <span class="card-icon">‚ö†Ô∏è</span>
                        <h3 class="card-title">Zona de Perigo</h3>
                    </div>
                    <div class="card-body">
                        <div class="card-content-section">
                            <p class="card-description">
                                <strong>‚ö†Ô∏è Esta a√ß√£o √© irrevers√≠vel!</strong>
                            </p>
                            <p class="card-description">
                                Ao excluir sua conta, todos os dados ser√£o perdidos permanentemente.
                            </p>
                        </div>
                        <div class="card-button-section">
                            <button class="btn btn-delete-account" id="delete-account-btn">
                                <span class="btn-icon">üóëÔ∏è</span>
                                Excluir Conta Permanentemente
                            </button>
                        </div>
                    </div>
                </section>
            </div>
        </div>

        <!-- Se√ß√£o de Suporte - Rodap√© -->
        <div class="support-footer-card">
            <h3 class="support-footer-title">
                <span class="support-icon">üí¨</span>
                Suporte
            </h3>
            <p class="support-footer-text">Precisa de ajuda? Entre em contato conosco:</p>
            <div class="support-footer-contact">
                <span class="support-email">prod.ai@gmail.com</span>
            </div>
            <div class="support-footer-info">
                <div class="support-footer-item">
                    <span class="support-item-icon">üìû</span>
                    <span>Suporte telef√¥nico: Seg-Sex, 9h-18h</span>
                </div>
                <div class="support-footer-item">
                    <span class="support-item-icon">üí¨</span>
                    <span>Chat online: 24/7</span>
                </div>
                <div class="support-footer-item">
                    <span class="support-item-icon">‚ö°</span>
                    <span>Resposta em at√© 2 horas</span>
                </div>
            </div>
        </div>
    </div>

    <div class="background-effects">
        <div class="grid-pattern"></div>
        <div class="glow-effect glow-1"></div>
        <div class="glow-effect glow-2"></div>
        <div class="neural-network">
            <div class="neural-node node-1"></div>
            <div class="neural-node node-2"></div>
            <div class="neural-node node-3"></div>
        </div>
    </div>

    <!-- Firebase e Script de Gerenciamento -->
    <script type="module">
        // Aguardar um pouco para garantir que o Firebase carregue
        setTimeout(async () => {
            const { auth } = await import('./firebase.js');
            const { onAuthStateChanged, updatePassword } = await import('https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js');
            
            console.log('üîß Gerenciar.js carregado');
            
            // Elementos do DOM
            const newPasswordInput = document.getElementById('new-password');
            const confirmPasswordInput = document.getElementById('confirm-password');
            const updatePasswordBtn = document.getElementById('update-password-btn');
            const backToChatBtn = document.getElementById('back-to-chat-simple');
            
            // Verificar se o usu√°rio est√° autenticado
            let currentUser = null;
            
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    console.log('‚úÖ Usu√°rio autenticado:', user.email);
                    
                    // Atualizar informa√ß√µes do usu√°rio na p√°gina
                    updateUserInfo(user);
                } else {
                    console.log('‚ùå Usu√°rio n√£o autenticado - redirecionando...');
                    // Redirecionar usu√°rios n√£o autenticados
                    window.location.href = 'login.html';
                }
            });
            
            // Fun√ß√£o para atualizar informa√ß√µes do usu√°rio
            function updateUserInfo(user) {
                // Voc√™ pode expandir isso para mostrar mais informa√ß√µes do usu√°rio
                console.log('üìß Email do usu√°rio:', user.email);
                console.log('üÜî UID do usu√°rio:', user.uid);
            }
            
            // Fun√ß√£o para mostrar mensagens de feedback
            function showMessage(message, type = 'success') {
                // Remove mensagem anterior se existir
                const existingMessage = document.querySelector('.feedback-message');
                if (existingMessage) {
                    existingMessage.remove();
                }
                
                // Criar elemento de mensagem
                const messageDiv = document.createElement('div');
                messageDiv.className = `feedback-message ${type}`;
                messageDiv.textContent = message;
                
                // Adicionar ao card de alterar senha
                const passwordCard = updatePasswordBtn.closest('.function-card');
                passwordCard.insertBefore(messageDiv, passwordCard.querySelector('.card-body'));
                
                // Auto-remover ap√≥s 5 segundos
                setTimeout(() => {
                    if (messageDiv.parentNode) {
                        messageDiv.remove();
                    }
                }, 5000);
            }
            
            // Fun√ß√£o para validar senha
            function validatePassword(password) {
                if (password.length < 6) {
                    return 'A senha deve ter pelo menos 6 caracteres';
                }
                return null;
            }
            
            // Fun√ß√£o principal para alterar senha
            async function changePassword() {
                if (!currentUser) {
                    showMessage('Usu√°rio n√£o autenticado. Redirecionando para login...', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                const newPassword = newPasswordInput.value.trim();
                const confirmPassword = confirmPasswordInput.value.trim();
                
                // Valida√ß√µes
                if (!newPassword || !confirmPassword) {
                    showMessage('Por favor, preencha todos os campos', 'error');
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showMessage('As senhas n√£o coincidem', 'error');
                    return;
                }
                
                const passwordError = validatePassword(newPassword);
                if (passwordError) {
                    showMessage(passwordError, 'error');
                    return;
                }
                
                // Desabilitar bot√£o durante o processo
                updatePasswordBtn.disabled = true;
                updatePasswordBtn.textContent = 'Atualizando...';
                
                try {
                    // Atualizar senha no Firebase
                    await updatePassword(currentUser, newPassword);
                    
                    console.log('‚úÖ Senha atualizada com sucesso');
                    showMessage('‚úÖ Senha atualizada com sucesso!', 'success');
                    
                    // Limpar campos
                    newPasswordInput.value = '';
                    confirmPasswordInput.value = '';
                    
                } catch (error) {
                    console.error('‚ùå Erro ao atualizar senha:', error);
                    
                    // Tratamento de erros espec√≠ficos
                    let errorMessage = 'Erro ao atualizar senha. Tente novamente.';
                    
                    switch (error.code) {
                        case 'auth/requires-recent-login':
                            errorMessage = 'üîí Para alterar a senha, voc√™ precisa fazer login novamente. Redirecionando...';
                            setTimeout(() => {
                                window.location.href = 'login.html';
                            }, 3000);
                            break;
                        case 'auth/weak-password':
                            errorMessage = 'üîê A senha √© muito fraca. Use pelo menos 6 caracteres.';
                            break;
                        case 'auth/network-request-failed':
                            errorMessage = 'üåê Erro de conex√£o. Verifique sua internet e tente novamente.';
                            break;
                        case 'auth/too-many-requests':
                            errorMessage = '‚è∞ Muitas tentativas. Tente novamente em alguns minutos.';
                            break;
                        default:
                            errorMessage = `‚ùå Erro: ${error.message}`;
                    }
                    
                    showMessage(errorMessage, 'error');
                } finally {
                    // Reabilitar bot√£o
                    updatePasswordBtn.disabled = false;
                    updatePasswordBtn.textContent = 'Atualizar senha';
                }
            }
            
            // Event Listeners
            if (updatePasswordBtn) {
                updatePasswordBtn.addEventListener('click', changePassword);
            }
            
            // Permitir Enter nos campos de senha
            if (newPasswordInput) {
                newPasswordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        changePassword();
                    }
                });
            }
            
            if (confirmPasswordInput) {
                confirmPasswordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        changePassword();
                    }
                });
            }
            
            // Bot√£o voltar ao chat
            if (backToChatBtn) {
                backToChatBtn.addEventListener('click', function() {
                    window.location.href = 'index.html';
                });
            }
            
            console.log('üîß Event listeners configurados');
        }, 100);
    </script>
</body>
</html>