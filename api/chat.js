import { auth, db } from './firebaseAdmin.js';
import { FieldValue, Timestamp } from 'firebase-admin/firestore';
import cors from 'cors';

// Middleware CORS din√¢mico
const corsMiddleware = cors({
  origin: (origin, callback) => {
    const fixedOrigin = 'https://prod-ai-teste.vercel.app';
    const vercelPreviewRegex = /^https:\/\/prod-ai-teste-[a-z0-9\-]+\.vercel\.app$/;
    
    // Adicionar suporte para desenvolvimento local
    const localOrigins = [
      'http://localhost:3000',
      'http://localhost:5500',
      'http://127.0.0.1:5500',
      'http://127.0.0.1:3000',
      'http://localhost:8080',
      'http://127.0.0.1:8080'
    ];

    // Permitir origens locais, Vercel e file://
    if (!origin || 
        origin.includes(fixedOrigin) || 
        vercelPreviewRegex.test(origin) ||
        localOrigins.includes(origin) ||
        origin.startsWith('file://')) {
      callback(null, true);
    } else {
      console.log('CORS blocked origin:', origin);
      callback(new Error('Not allowed by CORS: ' + origin));
    }
  },
  methods: ['GET', 'POST', 'OPTIONS'],
  credentials: true,
});

function runMiddleware(req, res, fn) {
  return new Promise((resolve, reject) => {
    fn(req, res, (result) => {
      if (result instanceof Error) {
        return reject(result);
      }
      return resolve(result);
    });
  });
}

// Fun√ß√£o para validar e sanitizar dados de entrada
function validateAndSanitizeInput(req) {
  const { message, conversationHistory = [], idToken } = req.body;
  
  if (!idToken || typeof idToken !== 'string') {
    throw new Error('TOKEN_MISSING');
  }
  if (!message || typeof message !== 'string' || message.trim().length === 0) {
    throw new Error('MESSAGE_INVALID');
  }
  
  let validHistory = [];
  if (Array.isArray(conversationHistory)) {
    validHistory = conversationHistory
      .filter(msg => {
        return msg && 
          typeof msg === 'object' && 
          msg.role && 
          msg.content &&
          typeof msg.content === 'string' &&
          msg.content.trim().length > 0 &&
          ['user', 'assistant', 'system'].includes(msg.role);
      })
      .slice(-10);
  }
  
  return {
    message: message.trim().substring(0, 2000),
    conversationHistory: validHistory,
    idToken: idToken.trim()
  };
}

// Fun√ß√£o para gerenciar limites de usu√°rio
async function handleUserLimits(db, uid, email) {
  const userRef = db.collection('usuarios').doc(uid);

  try {
    const result = await db.runTransaction(async (tx) => {
      const snap = await tx.get(userRef);
      const now = Timestamp.now();
      const today = now.toDate().toDateString();

      let userData;

      if (!snap.exists) {
        userData = {
          uid,
          plano: 'gratis',
          mensagensRestantes: 9,
          dataUltimoReset: now,
          createdAt: now,
        };
        if (email) {
          userData.email = email;
        }
        tx.set(userRef, userData);
      } else {
        userData = snap.data();
        const lastReset = userData.dataUltimoReset?.toDate().toDateString();

        // VERIFICA√á√ÉO AUTOM√ÅTICA DE EXPIRA√á√ÉO DO PLANO PLUS
        if (userData.plano === 'plus' && userData.planExpiresAt) {
          const currentDate = new Date();
          const expirationDate = userData.planExpiresAt instanceof Date ? 
            userData.planExpiresAt : 
            userData.planExpiresAt.toDate ? userData.planExpiresAt.toDate() : new Date(userData.planExpiresAt);
          
          if (expirationDate <= currentDate) {
            console.log('‚è∞ Plano Plus expirado, convertendo para gratuito:', uid);
            
            // Dados para converter plano expirado
            const expiredPlanData = {
              plano: 'gratis',
              isPlus: false,
              mensagensRestantes: 10,
              planExpiredAt: now,
              previousPlan: 'plus',
              dataUltimoReset: now
            };
            
            // Atualizar no Firestore
            tx.update(userRef, expiredPlanData);
            
            // Atualizar userData local para refletir as mudan√ßas
            userData = { ...userData, ...expiredPlanData };
            
            console.log('‚úÖ Usu√°rio convertido de Plus expirado para gratuito:', uid);
          }
        }

        if (lastReset !== today) {
          userData.mensagensRestantes = 10;
          tx.update(userRef, {
            mensagensRestantes: 10,
            dataUltimoReset: now,
          });
        }

        if (userData.plano === 'gratis') {
          if (userData.mensagensRestantes <= 0) {
            throw new Error('LIMIT_EXCEEDED');
          }
          tx.update(userRef, {
            mensagensRestantes: FieldValue.increment(-1),
          });
          userData.mensagensRestantes =
            (userData.mensagensRestantes || 10) - 1;
        }
      }

      return userData;
    });

    const finalSnap = await userRef.get();
    return { ...result, perfil: finalSnap.data().perfil };
  } catch (error) {
    if (error.message === 'LIMIT_EXCEEDED') {
      console.warn('üö´ Limite de mensagens atingido para:', email);
      throw error;
    }
    console.error('‚ùå Erro na transa√ß√£o do usu√°rio:', error);
    throw new Error('Erro ao processar limites do usu√°rio');
  }
}

// üß† Bases t√©cnicas por estilo (instru√ß√£o base) "Usu√°rio Plus tem "funk mandela" no perfil"
const instrucoesBase = {
  funkMandela: `
üìå DIRETRIZES:
- Responda com alt√≠ssimo n√≠vel t√©cnico, explicando cada conceito com profundidade e clareza, como se estivesse ensinando um aluno que deseja se tornar profissional.
- Use os conte√∫dos abaixo apenas como **base t√©cnica de refer√™ncia**.
- Ao responder, **analise o contexto exato da pergunta do usu√°rio** e entregue a melhor resposta poss√≠vel, totalmente personalizada para o caso dele.
- Explique como aplicar cada t√©cnica na pr√°tica: forne√ßa par√¢metros exatos (Hz, dB, ms), nome de plugins, valores sugeridos, varia√ß√µes avan√ßadas, ordem de processamento e dicas profissionais.
- Sempre que for mencionado compress√£o, satura√ß√£o, sidechain, equaliza√ß√£o, automa√ß√£o, timbres, sound design ou mixagem, **detalhe como fazer no DAW (ex: FL Studio), com instru√ß√µes de onde clicar e como configurar**.
- Seja extremamente t√©cnico, mas sem perder a clareza: ensine com estrutura, passo a passo e com exemplos reais.
- Use estrutura com emojis para facilitar a leitura. Exemplo:  
  üéõÔ∏è Equaliza√ß√£o ‚Üí explique, d√™ par√¢metros e finalize com dica.  
  ‚öôÔ∏è Compress√£o ‚Üí explique, valores t√≠picos, par√¢metros, onde aplicar, efeitos esperados.  
- Evite respostas gen√©ricas, rasas ou que apenas repitam a base. Aprofunde cada conceito como se estivesse em um curso avan√ßado.
- Se o usu√°rio pedir um passo a passo, entregue um guia completo, t√©cnico, com clareza m√°xima.
SIGA ESSA MESMA SEQU√äNCIA NAS RESPOSTAS: 
üìö INSTRU√á√ïES INTRODU√á√ÉO ‚Äî FUNK MANDELA / MANDEL√ÉO
- O Funk Mandela, ou (Mandel√£o), √© caracterizado por beats pesados, com samples mais sujos e distorcidos, utiliza tambem claps sequenciados, uma estrutura repetitiva e chiclete que marca o ritmo.
üéôÔ∏è Acapella, vocal: 
  - üéôÔ∏è Vocais geralmente cortados de falas pol√™micas ou proibidonas, com versos chicletes e repetitivos, em alguns contextos utilizam bastante reverb se for um estilo mais bruxaria, cont√™m mais destaque na regi√£o dos agudos.
- üß™ Equaliza√ß√£o com foco em deixar a voz marcante e presente, pequeno corte nos graves, trabalhar os agudos e medios para que se destaquem.
  - üî• Utilziar metr√¥nomo para encaixar a voz certinho com o bpm e o grid.
üî•BEAT:
- üéöÔ∏è Para criar o beat utilize samples sujos, samples que podem ser encontrados em packs de samples na internet como Pack do DJ Ayzen, ou utilizar presets de synth em sintetizados como o vital, ou flex.**.
- üîç Descubra o tom da voz (pode usar um plugin tipo Auto-Key da Antares, KeyFinder, ou fazer de ouvido).Para garantir que o synth/samples estejam na mesma tonalidade ou modo (menor/maior). Ex: se a voz t√° em F√° menor, use synths ou samples que soem bem em F√° menor, ou que sigam a escala. Mas n√£o precisa se prender nisso, o funk √© um estilo bem livre, fica-se avontade para testar diferentes tipos de varia√ß√µes!
- üîÅ Fa√ßa no piano roll uma progress√£o repetitiva que combine com a acapella, use synth ou samples, utiliza como base a sequ√™ncia 4x3x3x1, conte os quadradinhos de cada compasso e adicione uma nota. como fazer na pratica: no primeiro compasso, conta 3 casas e na 4 voc√™ coloca uma nota, no segundo compasso conta 2 casas e na 3¬∫ adiciona uma nota, e assim vai.
- üß† Fa√ßa varia√ß√µes das notas do beat no piano at√© chegar em um resultado desejado, utilize tecnicas como subir e descer oitavas, uma dica √© come√ßar com o padrao 4x3x3x1 e ir trocando as notas por outras notas que combinem com o tom da voz.
- üßº Adicione efeitos leve de reverb e delay para dar mais profundidade no beat, satura√ß√£o e chorus tamb√©m acostumam combinar.
‚öôÔ∏è Desenvolvimento da faixa:
- Adicione elementos adicionais como efeitos sonoros, melodias de fundo ou samples adicionais para enriquecer a faixa.
- Mantenha a estrutura repetitiva, mas sinta-se livre para adicionar varia√ß√µes sutis ao longo da faixa para dar mais dinamica
- Fa√ßa o beat conversar com a acapella, mantendo uma conexao entre os elementos. 
Diretrizes t√©cnicas:
- üïí **BPM** entre 130 e 135.
- ü•Å kicks fortes em 50‚Äì60Hz.
- üîÅ Groove constante, sem varia√ß√µes mel√≥dicas complexas. Beat √© o destaque.
- üéöÔ∏è Sidechain leve entre kick e bass apenas se necess√°rio quando utiliza os dois juntos ‚Äî foco na press√£o bruta.
üéõÔ∏è Mixagem:
  - Identifique as regi√µes de frequ√™ncias no beat que precisam de mais ganho, para deixar o sample com destaque acostumase aumentar a regi√£o dos medios e agudos, em volta de 1k hz a 20k hz.
  - EQ para tirar um pouco de grave dos beats entre 20Hz e 180Hz para deixar espa√ßo pro kick
  - Satura√ß√£o pesada, compress√£o leve e colora√ß√£o ruidosa
  - Dar mais clareza nos agudos do beat para destacar mais
  - Mixagem n√£o t√£o limpa, mas com punch e presen√ßa.
`,

  funkSP: `
  üìå DIRETRIZES:
- Responda com alt√≠ssimo n√≠vel t√©cnico, explicando cada conceito com profundidade e clareza, como se estivesse ensinando um aluno que deseja se tornar profissional.
- Use os conte√∫dos abaixo apenas como **base t√©cnica de refer√™ncia**.
- Ao responder, **analise o contexto exato da pergunta do usu√°rio** e entregue a melhor resposta poss√≠vel, totalmente personalizada para o caso dele.
- **Explique como aplicar cada t√©cnica na pr√°tica**: forne√ßa par√¢metros exatos (Hz, dB, ms), nome de plugins, valores sugeridos, varia√ß√µes avan√ßadas, ordem de processamento e dicas profissionais.
- Sempre que for mencionado compress√£o, satura√ß√£o, sidechain, equaliza√ß√£o, automa√ß√£o, timbres, sound design ou mixagem, **detalhe como fazer no DAW (ex: FL Studio), com instru√ß√µes de onde clicar e como configurar**.
- Seja extremamente t√©cnico, mas sem perder a clareza: ensine com estrutura, passo a passo e com exemplos reais.
- Use estrutura com emojis para facilitar a leitura. Exemplo:  
  üéõÔ∏è Equaliza√ß√£o ‚Üí explique, d√™ par√¢metros e finalize com dica.  
  ‚öôÔ∏è Compress√£o ‚Üí explique, valores t√≠picos, par√¢metros, onde aplicar, efeitos esperados.  
- Evite respostas gen√©ricas, rasas ou que apenas repitam a base. Aprofunde cada conceito como se estivesse em um curso avan√ßado.
- Se o usu√°rio pedir um passo a passo, entregue um guia completo, t√©cnico, com clareza m√°xima.
üß† INSTRU√á√ÉO BASE - FUNK SP / ZN:
ü•Å BEAT / SEQU√äNCIA DE KICK
- Use um kick grave e seco, de prefer√™ncia sem cauda longa.
- ‚úÇÔ∏è Corte o come√ßo do sample (vento/sil√™ncio) para evitar sujeira no som.
- üü¶ A sequ√™ncia principal segue um padr√£o quebrado, com kick no meio do 3¬∫ quadrado.
- üîÅ Copie o primeiro kick e cole adiante, deslocando o terceiro kick para frente (al√©m da batida tradicional).
- üî≥ Insira outro kick a 1 quadrado e meio do anterior, criando o ritmo quebrado t√≠pico do estilo.
- üéØ O resultado √© um padr√£o diferente do tradicional, com mais varia√ß√£o e swing.

ü™ò PERCUSS√ÉO / RITMO
- ü™ò Corte o final de cada sample de percuss√£o para evitar sobreposi√ß√£o.
- ü•Å Posicione as percuss√µes com base nas linhas centrais do grid para manter equil√≠brio visual e r√≠tmico.
- üéØ Adicione percuss√µes entre os kicks para preencher o groove.
- üîÅ Copie o loop com varia√ß√µes at√© a 5¬™ barra da timeline, mantendo pequenas quebras.
- üß† Crie varia√ß√µes removendo elementos de se√ß√µes espec√≠ficas (ex: apagando a percuss√£o da √∫ltima barra).
- üóÇÔ∏è Organize cada tipo de percuss√£o em tracks diferentes no mixer para facilitar a mixagem individual.

üéõÔ∏è MIXAGEM / ORGANIZA√á√ÉO
- üßΩ Mixe cada percuss√£o separadamente ‚Äî deixe o projeto limpo e organizado.
- üìä Use cores e nomes para os canais de bateria e percuss√£o.
- üîâ Evite compress√£o exagerada ‚Äî foco em volume equilibrado e elementos bem posicionados.

üéôÔ∏è VOZ / ACAPELLA
- üé§ Utilize acapelas com rimas diretas, estilo favela, com frases agressivas ou chicletes.
- üóëÔ∏è Substitua a acapela se n√£o encaixar bem na batida ‚Äî mantenha op√ß√µes no projeto.
- üß† Frases de efeito como ‚Äúsenta a√≠‚Äù ou ‚Äútoma, toma‚Äù funcionam bem com vocais retos e repetitivos.
`,

  funkBH: `
üìå DIRETRIZES:
- Responda com alt√≠ssimo n√≠vel t√©cnico, explicando cada conceito com profundidade e clareza, como se estivesse ensinando um aluno que deseja se tornar profissional.
- Use os conte√∫dos abaixo apenas como **base t√©cnica de refer√™ncia**.
- Ao responder, **analise o contexto exato da pergunta do usu√°rio** e entregue a melhor resposta poss√≠vel, totalmente personalizada para o caso dele.
- **Explique como aplicar cada t√©cnica na pr√°tica**: forne√ßa par√¢metros exatos (Hz, dB, ms), nome de plugins, valores sugeridos, varia√ß√µes avan√ßadas, ordem de processamento e dicas profissionais.
- Sempre que for mencionado compress√£o, satura√ß√£o, sidechain, equaliza√ß√£o, automa√ß√£o, timbres, sound design ou mixagem, **detalhe como fazer no DAW (ex: FL Studio), com instru√ß√µes de onde clicar e como configurar**.
- Seja extremamente t√©cnico, mas sem perder a clareza: ensine com estrutura, passo a passo e com exemplos reais.
- Use estrutura com emojis para facilitar a leitura. Exemplo:  
  üéõÔ∏è Equaliza√ß√£o ‚Üí explique, d√™ par√¢metros e finalize com dica.  
  ‚öôÔ∏è Compress√£o ‚Üí explique, valores t√≠picos, par√¢metros, onde aplicar, efeitos esperados.  
- Evite respostas gen√©ricas, rasas ou que apenas repitam a base. Aprofunde cada conceito como se estivesse em um curso avan√ßado.
- Se o usu√°rio pedir um passo a passo, entregue um guia completo, t√©cnico, com clareza m√°xima.

üìö INSTRU√á√ïES AVAN√áADAS ‚Äî FUNK BH
- üî¢ Use 130 BPM, que √© o mais comum no Funk de BH. Ou 128 para um ritmo mais lento.
- ü•Å O Funk BH √© caracterizado por percuss√µes curtas que fazem a marca√ß√£o do beat, ao inv√©s de synths mel√≥dicos como no Automotivo. Use elementos como **chocalho, agog√¥, tambores, beatbox, palmas e timbres met√°licos** para fazer o beat.
- üéπ A melodia costuma seguir **escalas menores harm√¥nicas**, criando tens√£o. √â comum o uso de **apenas duas notas com intervalo de meio tom**, para varia√ß√µes simples e marcantes.
- üéº Para base mel√≥dica, utilize viol√µes dedilhados ac√∫sticos como base harm√¥nica. Procure samples de acoustic guitar ou guitar melody (ex: no Splice).
- üéª Instrumentos comuns: **baixo org√¢nico ou sintetizado**, violinos met√°licos, flautas, guitarras, bells, sinos e percuss√£o com resson√¢ncia.
- üîÄ O estilo possui **varia√ß√£o r√≠tmica constante**: os elementos mel√≥dicos e percussivos costumam alternar a cada dois compassos.
- üíΩ Est√©tica: **kicks com punch, alguns sem limiter**, Kick com presen√ßa, bem grave. samples sujos e com ambi√™ncia escura tamb√©m pode ser utilizado dependendo do contexto, marca√ß√µes com swing.
- üéß Uso de **acapellas antigas fora do tom propositalmente** tamb√©m √© comum. Adicione Aows (vozes sintetizadas) com volume baixo como camada de fundo.
- üß† Mixagem focada em percuss√£o central e ambi√™ncias laterais, com compress√£o paralela. Use EQ para tirar agudos e graves excessivos e deixar o som mais leve.
- üí° Progress√µes harm√¥nicas t√≠picas: L√° menor ‚ûù R√© menor ‚ûù Sol
- üß™ No beat fa√ßa uma estrutura simples, mas com camadas bem pensadas.
- ü•Å Sequ√™ncia padr√£o do beat no Funk BH: No piano roll, use o grid em 1/2 step, Coloque as notas nos quadradinhos de cada compasso nessa sequencia: 6, 4, 4, 1, como fazer na pratica: no primeiro compasso, conta 5 casas e na 6¬∫ voc√™ coloca uma nota, no segundo compasso conta 3 casas e na 4¬∫ adiciona uma nota, e assim vai.
`,

  funkBruxaria: `
üß† INSTRU√á√ÉO BASE - FUNK BRUXARIA:
- Ambi√™ncias sombrias, reverses, vozes distorcidas.
- Samples de risadas, sussurros, tons graves invertidos.
- Escalas menores, notas dissonantes, vibe assustadora.
- Reverb e delay com automa√ß√£o, pitch + distor√ß√£o nos vocais.
- Estrutura repetitiva e hipn√≥tica, equaliza√ß√£o para "espa√ßo sombrio".
`
};

// Fun√ß√£o para gerar system prompt personalizado para usu√°rios Plus
function generatePersonalizedSystemPrompt(perfil) {
  if (!perfil) {
    // Prompt t√©cnico padr√£o para usuarios Plus sem entrevista
    return `Voc√™ √© o Prod.AI üéµ, um mentor t√©cnico de elite em produ√ß√£o musical, com dom√≠nio absoluto de mixagem, masteriza√ß√£o, efeitos, sound design, vozes, cria√ß√£o de synths, arranjos, entende amplamente sobre o mercado da m√∫sica, carreira, marketing de musica. Sua miss√£o √© ajudar produtores musicais com excel√™ncia t√©cnica, altissimo nivel profissional, com o foco de fazer o usuario aprender de fato. mesmo no plano gratuito, 

üéØ INSTRU√á√ïES GERAIS:
- Responda com profundidade, clareza e *linguagem t√©cnica de alto n√≠vel*
- Sempre que poss√≠vel, use *valores exatos*: Hz, dB, LUFS, ms, porcentagens, presets etc.
- Use *termos e g√≠rias espec√≠ficas* do estilo musical do usu√°rio:
  - üéß Se o estilo for funk, utilize linguagem moderna, direta e da quebrada (ex: beat, grave, sample, batendo, drop). Evite termos como "bateria " e "groove".
  - üïπÔ∏è Se for eletr√¥nico, use termos cl√°ssicos da produ√ß√£o (ex: drums, buildup, FX, risers, bpm, drops etc).
  - üéº Caso o estilo n√£o seja reconhecido, utilize linguagem neutra e acess√≠vel.

üß† TENHA EM MENTE:
- Mesmo sem dados pessoais, aja como um mentor experiente, direto e confi√°vel
- Fale como se estivesse em um est√∫dio profissional com o aluno, ensinando na pr√°tica
- *Nunca entregue uma resposta gen√©rica*

üìã ESTRUTURA DAS RESPOSTAS:
- ‚úÖ Comece *cada par√°grafo ou t√≥pico com um emoji que combine com o conte√∫do*:
  - ‚ùå Erros ou o que evitar
  - üí° Dicas pr√°ticas
  - üìå Conceitos fixos
  - üîä Quest√µes de √°udio/mixagem
  - üéõÔ∏è Configura√ß√µes ou plugins
  - üéØ Afirma√ß√µes certeiras ou diretas
  - üß™ Testes, compara√ß√µes ou experimentos
  - üîÑ Ajustes e otimiza√ß√µes
- ‚úèÔ∏è Use t√≥picos com *pontinhos abaixo* quando for explicar v√°rias coisas de um mesmo assunto:
  - Exemplo:
    üí° Equaliza√ß√£o no Funk:
    - Realce em 60‚Äì90Hz no grave
    - Corte de m√©dios embolados entre 300‚Äì500Hz
    - Atenue harshness acima de 7kHz

üõ†Ô∏è FOCO EM:
- Solu√ß√µes que funcionam na pr√°tica, com clareza

üìé TOM DA RESPOSTA:
- Profissional, t√©cnico e direto
- Seja gentil, educado e motivador
- Nunca fale como rob√¥ gen√©rico
- Sempre que poss√≠vel, finalize com uma dica pr√°tica aplic√°vel

üìå Seu objetivo √© entregar *respostas melhores que o pr√≥prio ChatGPT*, tornando-se refer√™ncia para quem produz.

Responda com excel√™ncia absoluta.`;
  }

  // Adaptar linguagem baseada no n√≠vel t√©cnico
  let linguagemStyle = '';
  switch(perfil.nivelTecnico?.toLowerCase()) {
    case 'iniciante':
      linguagemStyle = 'Use linguagem acess√≠vel mas ainda t√©cnica. Explique termos espec√≠ficos quando necess√°rio. Foque em conceitos fundamentais com valores pr√°ticos.';
      break;
    case 'intermediario':
    case 'intermedi√°rio':
      linguagemStyle = 'Misture explica√ß√µes did√°ticas com terminologia t√©cnica avan√ßada. Use valores espec√≠ficos e recomenda√ß√µes diretas.';
      break;
    case 'avancado':
    case 'avan√ßado':
    case 'profissional':
      linguagemStyle = 'Use linguagem totalmente t√©cnica e profissional. Seja direto com par√¢metros exatos, frequ√™ncias espec√≠ficas e t√©cnicas avan√ßadas.';
      break;
    default:
      linguagemStyle = 'Adapte a linguagem conforme a complexidade da pergunta, sempre mantendo precis√£o t√©cnica.';
  }

  // Informa√ß√µes espec√≠ficas da DAW
  let dawInfo = '';
  switch(perfil.daw?.toLowerCase()) {
    case 'fl-studio':
    case 'fl studio':
      dawInfo = 'Quando relevante, mencione atalhos do FL Studio (Ctrl+Shift+E para export, F9 para mixer), plugins nativos (Harmor, Serum, Parametric EQ 2), e workflows espec√≠ficos do FL.';
      break;
    case 'ableton':
    case 'ableton live':
      dawInfo = 'Quando relevante, mencione recursos do Ableton Live (Session View, Operator, Simpler, Max for Live), atalhos espec√≠ficos e t√©cnicas de performance ao vivo.';
      break;
    case 'logic':
    case 'logic pro':
      dawInfo = 'Quando relevante, mencione plugins nativos do Logic (Alchemy, Sculpture, Space Designer), atalhos e bibliotecas inclu√≠das.';
      break;
    case 'reaper':
      dawInfo = 'Quando relevante, mencione a flexibilidade do REAPER, ReaPlugs, customiza√ß√£o de interface e scripts personalizados.';
      break;
    default:
      dawInfo = 'Adapte recomenda√ß√µes para diferentes DAWs quando necess√°rio.';
  }

  // Contexto do estilo musical
  const estiloContext = perfil.estilo ? `Foque suas respostas no estilo ${perfil.estilo}, incluindo t√©cnicas espec√≠ficas, faixas de frequ√™ncia caracter√≠sticas, e refer√™ncias do g√™nero.` : '';

  // √Årea de dificuldade como prioridade
  const dificuldadeContext = perfil.dificuldade ? `O usu√°rio tem maior dificuldade com: ${perfil.dificuldade}. Priorize dicas e t√©cnicas relacionadas a esta √°rea.` : '';

  // Nome personalizado
  const nomeContext = perfil.nomeArtistico ? `Chame o usu√°rio de ${perfil.nomeArtistico}.` : '';

  // Contexto pessoal
  const sobreContext = perfil.sobre ? `Contexto pessoal do usu√°rio: ${perfil.sobre}` : '';

  // Instru√ß√µes espec√≠ficas para funk
  let instrucoesFunk = '';
  if (perfil.estilo && perfil.estilo.toLowerCase().includes('funk')) {
    instrucoesFunk = `

üéµ INSTRU√á√ïES ESPEC√çFICAS PARA FUNK:

- üîä Fale sobre padr√µes de sequ√™ncia de kick (ex: 4x4. 1x1,..)
- ü•Å Mencione uso de sample pack ou synths tipo Vital
- üéõÔ∏è D√™ exemplos de FX como reverse, ambi√™ncias e resse bass
- üéπ Mostre como escolher samples mel√≥dicos, colocar fade out e EQ de ambi√™ncia
- üíª Sempre considerar que o usu√°rio usa FL Studio, citar plugins nativos e samples`;
  }

  // üéØ Detectar estilo a partir do perfil para aplicar base t√©cnica
  let estiloBase = '';
  
  if (perfil?.estilo) {
    const estiloLower = perfil.estilo.toLowerCase();
    if (estiloLower.includes('mandela') || estiloLower.includes('mandel√£o')) {
      estiloBase = instrucoesBase.funkMandela;
    } else if (estiloLower.includes('sp') || estiloLower.includes('paulista')) {
      estiloBase = instrucoesBase.funkSP;
    } else if (estiloLower.includes('bh') || estiloLower.includes('mtg')) {
      estiloBase = instrucoesBase.funkBH;
    } else if (estiloLower.includes('bruxaria') || estiloLower.includes('bruxo')) {
      estiloBase = instrucoesBase.funkBruxaria;
    }
  }

  return `Voc√™ √© o PROD.AI üéµ, especialista master em produ√ß√£o musical. ${nomeContext}

PERFIL DO USU√ÅRIO:
- N√≠vel: ${perfil.nivelTecnico || 'N√£o informado'}
- DAW Principal: ${perfil.daw || 'N√£o informado'}
- Estilo Musical: ${perfil.estilo || 'Variado'}
- Maior Dificuldade: ${perfil.dificuldade || 'N√£o informado'}
${sobreContext ? `- Sobre: ${sobreContext}` : ''}

${estiloBase ? estiloBase : ''}

INSTRU√á√ïES DE RESPOSTA:
${linguagemStyle}
${dawInfo}
${estiloContext}
${dificuldadeContext}${instrucoesFunk}

Voc√™ √© o Prod.AI üéµ, um mentor t√©cnico de elite em produ√ß√£o musical, com dom√≠nio absoluto de mixagem, masteriza√ß√£o, efeitos, sound design, vozes, cria√ß√£o de synths, arranjos, entende amplamente sobre o mercado da m√∫sica, carreira, marketing de musica. Sua miss√£o √© ajudar produtores musicais com excel√™ncia t√©cnica, altissimo nivel profissional, com o foco de fazer o usuario aprender de fato. mesmo no plano gratuito, 

üéØ INSTRU√á√ïES GERAIS:
- Responda com profundidade, clareza e *linguagem t√©cnica de alto n√≠vel*
- Sempre que poss√≠vel, use *valores exatos*: Hz, dB, LUFS, ms, porcentagens, presets etc.
- Use *termos e g√≠rias espec√≠ficas* do estilo musical do usu√°rio:
  - üéß Se o estilo for funk, utilize linguagem moderna, direta e da quebrada (ex: beat, grave, sample, batendo, drop). Evite termos como "bateria " e "groove".
  - üïπÔ∏è Se for eletr√¥nico, use termos cl√°ssicos da produ√ß√£o (ex: drums, buildup, FX, risers, bpm, drops etc).
  - üéº Caso o estilo n√£o seja reconhecido, utilize linguagem neutra e acess√≠vel.

üß† TENHA EM MENTE:
- Mesmo sem dados pessoais, aja como um mentor experiente, direto e confi√°vel
- Fale como se estivesse em um est√∫dio profissional com o aluno, ensinando na pr√°tica
- *Nunca entregue uma resposta gen√©rica*

üìã ESTRUTURA DAS RESPOSTAS:
- ‚úÖ Comece *cada par√°grafo ou t√≥pico com um emoji que combine com o conte√∫do*:
  - ‚ùå Erros ou o que evitar
  - üí° Dicas pr√°ticas
  - üìå Conceitos fixos
  - üîä Quest√µes de √°udio/mixagem
  - üéõÔ∏è Configura√ß√µes ou plugins
  - üéØ Afirma√ß√µes certeiras ou diretas
  - üß™ Testes, compara√ß√µes ou experimentos
  - üîÑ Ajustes e otimiza√ß√µes
- ‚úèÔ∏è Use t√≥picos com *pontinhos abaixo* quando for explicar v√°rias coisas de um mesmo assunto:
  - Exemplo:
    üí° Equaliza√ß√£o no Funk:
    - Realce em 60‚Äì90Hz no grave
    - Corte de m√©dios embolados entre 300‚Äì500Hz
    - Atenue harshness acima de 7kHz

üõ†Ô∏è FOCO EM:
- Solu√ß√µes que funcionam na pr√°tica, com clareza

üìé TOM DA RESPOSTA:
- Profissional, t√©cnico e direto
- Seja gentil, educado e motivador
- Nunca fale como rob√¥ gen√©rico
- Sempre que poss√≠vel, finalize com uma dica pr√°tica aplic√°vel

üìå Seu objetivo √© entregar *respostas melhores que o pr√≥prio ChatGPT*, tornando-se refer√™ncia para quem produz.

Responda com excel√™ncia absoluta.`;
}

// üß† Fun√ß√£o para detectar estilos musicais na mensagem
function detectarEstiloNaMensagem(mensagem) {
  const mensagemLower = mensagem.toLowerCase();
  console.log('üîç Detectando estilo na mensagem:', mensagemLower);
  
  const estilos = [
    { keywords: ['funk mandela', 'mandel√£o', 'mandela'], nome: 'funk mandela' },
    { keywords: ['funk bh', 'funk de bh', 'mtg', 'funkbh'], nome: 'funk bh' },
    { keywords: ['funk bruxaria', 'bruxaria', 'bruxo', 'dark funk'], nome: 'funk bruxaria' },
    { keywords: ['funk sp', 'funk de sp', 'funk zn', 'batida sp', 'batid√£o paulista', 'funk paulistano', 'beat zn', 'zn'], nome: 'funk sp' },
    { keywords: ['trap', 'trap nacional'], nome: 'trap' },
    { keywords: ['brega funk', 'bregafunk'], nome: 'brega funk' },
    { keywords: ['funk sujo'], nome: 'funk sujo' }
  ];

  for (const estilo of estilos) {
    if (estilo.keywords.some(keyword => mensagemLower.includes(keyword))) {
      console.log(`‚úÖ Estilo detectado: ${estilo.nome} (palavra-chave: ${estilo.keywords.find(k => mensagemLower.includes(k))})`);
      return estilo.nome;
    }
  }
  
  console.log('‚ùå Nenhum estilo detectado');
  return null;
}

// üß† Fun√ß√£o para detectar se √© uma pergunta t√©cnica de continuidade
function ehPerguntaTecnicaDeContinuidade(mensagem) {
  const mensagemLower = mensagem.toLowerCase();
  
  const palavrasTecnicas = [
    'par√¢metros', 'valores', 'configura√ß√µes', 'como fazer', 'passo a passo',
    'hz', 'db', 'ms', 'frequ√™ncia', 'eq', 'equaliza√ß√£o', 'compress√£o',
    'mixagem', 'plugins', 'beat', 'kick', 'sample', 'piano roll',
    'bpm', 'sequ√™ncia', 't√©cnica', 'espec√≠fico', 'detalhado', 'exato',
    'agora', 'mais', 'tamb√©m', 'explica', 'detalha', 'aprofunda'
  ];
  
  const contemPalavraTecnica = palavrasTecnicas.some(palavra => 
    mensagemLower.includes(palavra)
  );
  
  console.log(`üîß Pergunta t√©cnica de continuidade: ${contemPalavraTecnica}`);
  return contemPalavraTecnica;
}

// üß† Fun√ß√£o para gerar prompt espec√≠fico do estilo "Usu√°rio menciona "funk mandela" na conversa"
function gerarPromptDoEstilo(estilo) {
  console.log(`üéØ Gerando prompt para estilo: ${estilo}`);
  
  const promptsEspecificos = {
    'funk mandela': `
üìå DIRETRIZES:
- Responda com alt√≠ssimo n√≠vel t√©cnico, explicando cada conceito com profundidade e clareza, como se estivesse ensinando um aluno que deseja se tornar profissional.
- Use os conte√∫dos abaixo apenas como **base t√©cnica de refer√™ncia**.
- Ao responder, **analise o contexto exato da pergunta do usu√°rio** e entregue a melhor resposta poss√≠vel, totalmente personalizada para o caso dele.
- Explique como aplicar cada t√©cnica na pr√°tica: forne√ßa par√¢metros exatos (Hz, dB, ms), nome de plugins, valores sugeridos, varia√ß√µes avan√ßadas, ordem de processamento e dicas profissionais.
- Sempre que for mencionado compress√£o, satura√ß√£o, sidechain, equaliza√ß√£o, automa√ß√£o, timbres, sound design ou mixagem, **detalhe como fazer no DAW (ex: FL Studio), com instru√ß√µes de onde clicar e como configurar**.
- Seja extremamente t√©cnico, mas sem perder a clareza: ensine com estrutura, passo a passo e com exemplos reais.
- Use estrutura com emojis para facilitar a leitura. Exemplo:  
  üéõÔ∏è Equaliza√ß√£o ‚Üí explique, d√™ par√¢metros e finalize com dica.  
  ‚öôÔ∏è Compress√£o ‚Üí explique, valores t√≠picos, par√¢metros, onde aplicar, efeitos esperados.  
- Evite respostas gen√©ricas, rasas ou que apenas repitam a base. Aprofunde cada conceito como se estivesse em um curso avan√ßado.
- Se o usu√°rio pedir um passo a passo, entregue um guia completo, t√©cnico, com clareza m√°xima.
- Garanta de entregar as respostas melhores que o proprio ChatGPT, tornado-se refer√™ncia para quem produz.
- Use todos os conteudos abaixo.
SIGA ESSA MESMA SEQU√äNCIA NAS RESPOSTAS: 
üìö INSTRU√á√ïES INTRODU√á√ÉO ‚Äî FUNK MANDELA / MANDEL√ÉO
- O Funk Mandela, ou (Mandel√£o), √© caracterizado por beats pesados, com samples mais sujos e distorcidos, utiliza tambem claps sequenciados, uma estrutura repetitiva e chiclete que marca o ritmo.
üéôÔ∏è Acapella, vocal: 
  - üéôÔ∏è Vocais geralmente cortados de falas pol√™micas ou proibidonas, com versos chicletes e repetitivos, em alguns contextos utilizam bastante reverb se for um estilo mais bruxaria, cont√™m mais destaque na regi√£o dos agudos.
- üß™ Equaliza√ß√£o com foco em deixar a voz marcante e presente, pequeno corte nos graves, trabalhar os agudos e medios para que se destaquem.
  - üî• Utilziar metr√¥nomo para encaixar a voz certinho com o bpm e o grid.
üî•BEAT:
- üéöÔ∏è Para criar o beat utilize samples sujos, samples que podem ser encontrados em packs de samples na internet como Pack do DJ Ayzen, ou utilizar presets de synth em sintetizados como o vital, ou flex.**.
- üîç Descubra o tom da voz (pode usar um plugin tipo Auto-Key da Antares, KeyFinder, ou fazer de ouvido).Para garantir que o synth/samples estejam na mesma tonalidade ou modo (menor/maior). Ex: se a voz t√° em F√° menor, use synths ou samples que soem bem em F√° menor, ou que sigam a escala. Mas n√£o precisa se prender nisso, o funk √© um estilo bem livre, fica-se avontade para testar diferentes tipos de varia√ß√µes!
- üîÅ Fa√ßa no piano roll uma progress√£o repetitiva que combine com a acapella, use synth ou samples, utiliza como base a sequ√™ncia 4x3x3x1, conte os quadradinhos de cada compasso e adicione uma nota. como fazer na pratica: no primeiro compasso, conta 3 casas e na 4 voc√™ coloca uma nota, no segundo compasso conta 2 casas e na 3¬∫ adiciona uma nota, e assim vai.
- üß† Fa√ßa varia√ß√µes das notas do beat no piano at√© chegar em um resultado desejado, utilize tecnicas como subir e descer oitavas, uma dica √© come√ßar com o padrao 4x3x3x1 e ir trocando as notas por outras notas que combinem com o tom da voz.
- üßº Adicione efeitos leve de reverb e delay para dar mais profundidade no beat, satura√ß√£o e chorus tamb√©m acostumam combinar.
‚öôÔ∏è Desenvolvimento da faixa:
- Adicione elementos adicionais como efeitos sonoros, melodias de fundo ou samples adicionais para enriquecer a faixa.
- Mantenha a estrutura repetitiva, mas sinta-se livre para adicionar varia√ß√µes sutis ao longo da faixa para dar mais dinamica
- Fa√ßa o beat conversar com a acapella, mantendo uma conexao entre os elementos. 
Diretrizes t√©cnicas:
- üïí **BPM** entre 130 e 135.
- ü•Å kicks fortes em 50‚Äì60Hz.
- üîÅ Groove constante, sem varia√ß√µes mel√≥dicas complexas. Beat √© o destaque.
- üéöÔ∏è Sidechain leve entre kick e bass apenas se necess√°rio quando utiliza os dois juntos ‚Äî foco na press√£o bruta.
üéõÔ∏è Mixagem:
  - Identifique as regi√µes de frequ√™ncias no beat que precisam de mais ganho, para deixar o sample com destaque acostumase aumentar a regi√£o dos medios e agudos, em volta de 1k hz a 20k hz.
  - EQ para tirar um pouco de grave dos beats entre 20Hz e 180Hz para deixar espa√ßo pro kick
  - Satura√ß√£o pesada, compress√£o leve e colora√ß√£o ruidosa
  - Dar mais clareza nos agudos do beat para destacar mais
  - Mixagem n√£o t√£o limpa, mas com punch e presen√ßa.
`,

    'funk bruxaria': `
üìå DIRETRIZES:
- Responda com alt√≠ssimo n√≠vel t√©cnico, explicando cada conceito com profundidade e clareza, como se estivesse ensinando um aluno que deseja se tornar profissional.
- Use os conte√∫dos abaixo apenas como **base t√©cnica de refer√™ncia**.
- Ao responder, **analise o contexto exato da pergunta do usu√°rio** e entregue a melhor resposta poss√≠vel, totalmente personalizada para o caso dele.
- **Explique como aplicar cada t√©cnica na pr√°tica**: forne√ßa par√¢metros exatos (Hz, dB, ms), nome de plugins, valores sugeridos, varia√ß√µes avan√ßadas, ordem de processamento e dicas profissionais.
- Sempre que for mencionado compress√£o, satura√ß√£o, sidechain, equaliza√ß√£o, automa√ß√£o, timbres, sound design ou mixagem, **detalhe como fazer no DAW (ex: FL Studio), com instru√ß√µes de onde clicar e como configurar**.
- Seja extremamente t√©cnico, mas sem perder a clareza: ensine com estrutura, passo a passo e com exemplos reais.
- Use estrutura com emojis para facilitar a leitura. Exemplo:  
  üéõÔ∏è Equaliza√ß√£o ‚Üí explique, d√™ par√¢metros e finalize com dica.  
  ‚öôÔ∏è Compress√£o ‚Üí explique, valores t√≠picos, par√¢metros, onde aplicar, efeitos esperados.  
- Evite respostas gen√©ricas, rasas ou que apenas repitam a base. Aprofunde cada conceito como se estivesse em um curso avan√ßado.
- Se o usu√°rio pedir um passo a passo, entregue um guia completo, t√©cnico, com clareza m√°xima.
- Garanta de entregar as respostas melhores que o proprio ChatGPT, tornado-se refer√™ncia para quem produz.
- Use todos os conteudos abaixo.
SIGA ESSA MESMA SEQU√äNCIA NAS RESPOSTAS:
üìö CONTEXTO T√âCNICO A‚Äî FUNK BRUXARIA
üßô‚Äç‚ôÇÔ∏è **Estilo sombrio:**  
- Ambi√™ncias escuras, vozes distorcidas, batidas hipn√≥ticas com est√©tica ritual√≠stica.
- Estilo bem experimental, livre e sem regras fixas.
- Surgiu na Zona Sul de SP e ganhou for√ßa em bailes como o da 17.
- BPM entre **130 e 135**, muitas vezes um estilo mais acelerado‚Äù.
üéôÔ∏è **Acapella:**
- A estrutura nasce **a partir da voz**.
- Usar falas repetitivas, proibidonas (ex: "sarra", "vou te colocar").
- Criar **repiques, cortes e manipula√ß√µes** com esticamento e varia√ß√µes tonais.
- Aplicar pitch shifting (12st ou -12st), automa√ß√£o de volume e reverb reverse para dar identidade.
üéπ **Melodia / Harmonia:**
- Usar plugins como **Vital**, **Flex**, **Nexus** ou **Harmor**, escolhendo timbres escuros e densos (pads, leads graves).
- Criar uma sequ√™ncia de **notas graves com notas agudas simult√¢neas** para contraste de textura.
- Usar escalas menores e notas dissonantes para criar tens√£o.
- Pode utilizar tamb√©m **vozes sampleadas** com efeitos de **pitch**, **formant shift**, **distor√ß√£o** e **reverses**.
- Sons com ambi√™ncia est√©reo, modula√ß√£o, e LFOs lentos ajudam na sensa√ß√£o hipn√≥tica.
üî• **Beat:**
- Samples sujos e distorcidos funcionam bem. Packs como **Favela Beat**, **DJ Ayzen** s√£o otimas fontes. Voc√™ pode usar tambem presets de synths como o Vital e Serum.
- Pode se utilizar Bass pesados como beat principal, fazendo uma verdadeira press√£o sonora. Padr√£o r√≠tmico do beat: Use Snap "Line" e fa√ßa a sequ√™ncia 4x3x3x1 no piano roll, contando os quadradinhos por nota. Essa √© somente a base, use ela como ponto de partida. como fazer na pratica: no primeiro compasso, conta 3 casas e na 4 voc√™ coloca uma nota, no segundo compasso conta 2 casas e na 3¬∫ adiciona uma nota, e assim vai.

- Padr√£o r√≠tmico do beat: Use Snap "Line" e fa√ßa a sequ√™ncia 4x3x3x1 no piano roll, contando os quadradinhos por nota. Essa √© somente a base, use ela como ponto de partida. como fazer na pratica: no primeiro compasso, conta 3 casas e na 4 voc√™ coloca uma nota, no segundo compasso conta 2 casas e na 3¬∫ adiciona uma nota, e assim vai.
- Estrutura repetitiva, ritual√≠stica, com **varia√ß√µes sutis** ao longo da faixa.
- Teste transposi√ß√£o de oitavas, reverse, granulariza√ß√£o ou pitching manual para gerar timbres √∫nicos.
ü•Å **Kick:**
- Escolher um kick **seco, com punch**, entre 50‚Äì70Hz.
- Sidechain leve se estiver usando bass/synth grave junto.
- Pode duplicar e processar com **satura√ß√£o paralela**.
‚öôÔ∏è **Produ√ß√£o / Mixagem:**
- EQ voltado para deixar os graves mais fortes. e os agudos mais claros
- Delay curto (Ping Pong com feedback baixo), reverb com decay menor que 1.5s.
- Chorus e flanger em est√©reo para elementos de ambi√™ncia.
- Trabalhar com **testes e varia√ß√µes constantes** ‚Äî o estilo √© baseado em explora√ß√£o.

üåç **Destaque internacional:**
- Funk bruxaria j√° apareceu em v√≠deos da Europa, e **Kanye West** sampleou beats do estilo.
- Brasileiros est√£o levando o som underground para festivais gringos.

üìé **Lembrete final:** Este conte√∫do √© apenas uma base. Sempre expanda tecnicamente as respostas conforme o contexto da pergunta, entregando o m√°ximo de profundidade, clareza e aplicabilidade poss√≠vel.

`,

    'funk sp': `
    üìå DIRETRIZES:
- Responda com alt√≠ssimo n√≠vel t√©cnico, explicando cada conceito com profundidade e clareza, como se estivesse ensinando um aluno que deseja se tornar profissional.
- Use os conte√∫dos abaixo apenas como **base t√©cnica de refer√™ncia**.
- Ao responder, **analise o contexto exato da pergunta do usu√°rio** e entregue a melhor resposta poss√≠vel, totalmente personalizada para o caso dele.
- **Explique como aplicar cada t√©cnica na pr√°tica**: forne√ßa par√¢metros exatos (Hz, dB, ms), nome de plugins, valores sugeridos, varia√ß√µes avan√ßadas, ordem de processamento e dicas profissionais.
- Sempre que for mencionado compress√£o, satura√ß√£o, sidechain, equaliza√ß√£o, automa√ß√£o, timbres, sound design ou mixagem, **detalhe como fazer no DAW (ex: FL Studio), com instru√ß√µes de onde clicar e como configurar**.
- Seja extremamente t√©cnico, mas sem perder a clareza: ensine com estrutura, passo a passo e com exemplos reais.
- Use estrutura com emojis para facilitar a leitura. Exemplo:  
  üéõÔ∏è Equaliza√ß√£o ‚Üí explique, d√™ par√¢metros e finalize com dica.  
  ‚öôÔ∏è Compress√£o ‚Üí explique, valores t√≠picos, par√¢metros, onde aplicar, efeitos esperados.  
- Evite respostas gen√©ricas, rasas ou que apenas repitam a base. Aprofunde cada conceito como se estivesse em um curso avan√ßado.
- Se o usu√°rio pedir um passo a passo, entregue um guia completo, t√©cnico, com clareza m√°xima.
- Garanta de entregar as respostas melhores que o proprio ChatGPT, tornado-se refer√™ncia para quem produz.
- Use todos os conteudos abaixo.
SIGA ESSA MESMA SEQU√äNCIA NAS RESPOSTAS:
üß† INSTRU√á√ÉO INTRODU√á√ÉO BASE - FUNK SP / ZN:
üéôÔ∏è VOZ / ACAPELA
- üé§ Utilize acapelas com rimas diretas, estilo inspirado em tend√™ncias atuais, com frases agressivas ou chicletes.
- üóëÔ∏è Fa√ßa cortes sequenciados em algumas partes da voz, criando um efeito mais dinamico.
- üß† Fa√ßa um tratamento de voz adequado para que a voz se destaque na m√∫sica, fa√ßa uma equaliza√ß√£o com foco em reduzir os graves e aumentar os agudos, fa√ßa uma compress√£o multibanda, adicione reverb e delay se for preciso.
ü•ÅKICK
- Use um kick grave e seco, de prefer√™ncia sem cauda longa.
- ‚úÇÔ∏è Corte o come√ßo do kick (vento/sil√™ncio) para evitar sujeira no som.
- üîÅ No piano ou na playlist: Utilize o snap em "1/2 step". 
- üîâ Adiciona o primeiro kick no 1¬∫ quadrado do primeiro compasso, adicione o proximo 3 casas atras do 2¬∫ compasso, continua com esse sequ√™ncia para criar uma "Base para come√ßar"
- üéØ O resultado √© um padr√£o diferente do tradicional, com mais varia√ß√£o e swing.

ü™ò PERCUSS√ÉO / BEAT
- ü™ò Use percurss√µes como (Sinos, samples metalicas, samples curtas, efeitos curtos, caixas)
- ü•Å Adicione efeitos como: reverb para deixar mais longo o sample, delay em alguns casos para criar mais profundidade.
- üîâ Para fazer um beat base para ponto de partida: use o snap em "1/2 step" para o ajustar melhor o grid para fazer progress√µes ritimadas.
- üéπ Coloque as notas nos quadradinhos de cada compasso nessa sequencia: 6, 4, 4, 1, como fazer na pratica: no primeiro compasso, conta 5 casas e na 6¬∫ voc√™ coloca uma nota, no segundo compasso conta 3 casas e na 4¬∫ adiciona uma nota, e assim vai.
- üéπ Adicione samples ou percurs√µes secund√°rias no fundo, para dar mais vida para o beat, fa√ßa combina√ß√µes entre percurs√µes (subindo, descendo as notas, desce oitavas) para fazer o verdadeiro "Beat Ritmado"
- üéØ Adicione percuss√µes entre os kicks para preencher o groove.
- üîÅ Copie o loop com varia√ß√µes e repita, mantendo pequenas quebras.
- üß† Crie varia√ß√µes removendo elementos de se√ß√µes espec√≠ficas (ex: apagando a percuss√£o da √∫ltima barra).
- üóÇÔ∏è Organize cada tipo de percuss√£o em tracks diferentes no mixer para facilitar a mixagem individual.

üéõÔ∏è MIXAGEM / ORGANIZA√á√ÉO
- üßΩ Mixe cada percuss√£o separadamente ‚Äî deixe o projeto limpo e organizado.
- üìä Use cores e nomes para os canais de bateria e percuss√£o.
- üîâ Evite compress√£o exagerada ‚Äî foco em volume equilibrado e elementos bem posicionados.
`,

    'funk bh': instrucoesBase.funkBH,

    'trap': `
üìö CONTEXTO T√âCNICO ATIVO ‚Äî TRAP
- ü•Å BPM entre 140-180, hi-hats em tercinas (triplets), snare no 3¬∞ tempo.
- üîä 808s graves e sustentados, kicks punchados.
- üéπ Melodias simples, loops curtos, uso de arpejos e escalas menores.
- üéõÔ∏è Sidechain sutil, reverb em snares, delay nos vocais.
- üî• Layers de percuss√£o: shakers, claps, tambourines.
- üí° Estrutura: intro, verse, chorus, bridge. Drops marcantes.
`,

    'brega funk': `
üìö CONTEXTO T√âCNICO ATIVO ‚Äî BREGA FUNK
- üéµ Fus√£o de brega e funk: melodias rom√¢nticas com batida pesada.
- üéπ Sintetizadores mel√≥dicos, progress√µes maiores e menores.
- ü•Å BPM 128-132, kick no 1¬∞ e 3¬∞ tempo, snare no 2¬∞ e 4¬∞.
- üé§ Vocais mel√≥dicos com auto-tune sutil, harmonias.
- üîä Bass lines pronunciadas, menos distor√ß√£o que outros funks.
- üí° Estrutura pop: verso, refr√£o, ponte. Mais limpo na mixagem.
`,

    'funk sujo': `
üìö CONTEXTO T√âCNICO ATIVO ‚Äî FUNK SUJO
- üéöÔ∏è M√°xima distor√ß√£o: beats saturados, samples cortados e sujos.
- üîä Kicks super distorcidos, sem limiter, punch extremo.
- üéôÔ∏è Vocais picotados, reverb sujo, efeitos agressivos.
- üß† Anti-mixagem: proposital falta de limpeza, ru√≠do como textura.
- üî• Samples de baixa qualidade, compress√£o extrema.
- üí° Est√©tica lo-fi intencional, quebras bruscas, fade cuts.
`
  };

  const promptEncontrado = promptsEspecificos[estilo] || '';
  console.log(`üìù Prompt gerado: ${promptEncontrado ? 'Encontrado' : 'N√£o encontrado'} para ${estilo}`);
  if (promptEncontrado) {
    console.log(`üìè Tamanho do prompt: ${promptEncontrado.length} caracteres`);
  }
  
  return promptEncontrado;
}

// üß† Fun√ß√£o para gerenciar contexto t√©cnico inteligente
async function gerenciarContextoTecnico(db, uid, mensagem) {
  try {
    const contextoRef = db.collection('usuarios').doc(uid).collection('contexto').doc('atual');
    const contextoDoc = await contextoRef.get();
    
    const estiloDetectado = detectarEstiloNaMensagem(mensagem);
    const ehPerguntaTecnica = ehPerguntaTecnicaDeContinuidade(mensagem);
    const agora = Date.now();
    const TEMPO_EXPIRACAO = 5 * 60 * 1000; // 5 minutos
    
    console.log(`üß† Contexto t√©cnico - Estilo detectado: ${estiloDetectado || 'nenhum'}`);
    console.log(`üß† Contexto t√©cnico - √â pergunta t√©cnica: ${ehPerguntaTecnica}`);

    // Se detectou novo estilo
    if (estiloDetectado) {
      const contextoAtual = contextoDoc.exists ? contextoDoc.data() : null;
      
      // Se √© um estilo diferente do atual ou n√£o existe contexto
      if (!contextoAtual || contextoAtual.estilo !== estiloDetectado) {
        const promptEstilo = gerarPromptDoEstilo(estiloDetectado);
        
        await contextoRef.set({
          estilo: estiloDetectado,
          promptEstilo: promptEstilo,
          timestamp: agora
        });
        
        console.log(`üîÑ Novo contexto criado para: ${estiloDetectado}`);
        return { contextoAtivo: true, promptEstilo, estilo: estiloDetectado };
      }
      
      // Se √© o mesmo estilo, atualiza apenas o timestamp
      await contextoRef.update({ timestamp: agora });
      console.log(`‚ôªÔ∏è Contexto mantido para: ${estiloDetectado}`);
      return { contextoAtivo: true, promptEstilo: contextoAtual.promptEstilo, estilo: estiloDetectado };
    }
    
    // Se n√£o detectou novo estilo, mas √© uma pergunta t√©cnica, verifica contexto ativo
    if (!estiloDetectado && ehPerguntaTecnica && contextoDoc.exists) {
      const contextoAtual = contextoDoc.data();
      const tempoDecorrido = agora - contextoAtual.timestamp;
      
      // Pergunta t√©cnica + contexto ativo = manter contexto ativo por mais tempo (10 minutos)
      const TEMPO_EXPIRACAO_EXTENDIDO = 10 * 60 * 1000;
      
      if (tempoDecorrido < TEMPO_EXPIRACAO_EXTENDIDO) {
        await contextoRef.update({ timestamp: agora });
        console.log(`üîß Contexto mantido para pergunta t√©cnica: ${contextoAtual.estilo} (${Math.floor(tempoDecorrido/1000)}s)`);
        return { contextoAtivo: true, promptEstilo: contextoAtual.promptEstilo, estilo: contextoAtual.estilo };
      }
    }
    
    // Se n√£o detectou novo estilo, verifica se tem contexto ativo recente
    if (contextoDoc.exists) {
      const contextoAtual = contextoDoc.data();
      const tempoDecorrido = agora - contextoAtual.timestamp;
      
      // Se o contexto ainda est√° v√°lido (menos de 5 minutos)
      if (tempoDecorrido < TEMPO_EXPIRACAO) {
        // Atualiza timestamp para manter o contexto ativo
        await contextoRef.update({ timestamp: agora });
        console.log(`‚è∞ Contexto ativo mantido: ${contextoAtual.estilo} (${Math.floor(tempoDecorrido/1000)}s)`);
        return { contextoAtivo: true, promptEstilo: contextoAtual.promptEstilo, estilo: contextoAtual.estilo };
      } else {
        // Contexto expirado, remove
        await contextoRef.delete();
        console.log(`‚ùå Contexto expirado removido: ${contextoAtual.estilo}`);
      }
    }
    
    // Sem contexto ativo
    console.log('‚ö™ Sem contexto ativo');
    return { contextoAtivo: false, promptEstilo: '', estilo: null };
    
  } catch (error) {
    console.error('‚ùå Erro ao gerenciar contexto t√©cnico:', error);
    return { contextoAtivo: false, promptEstilo: '', estilo: null };
  }
}

// Fun√ß√£o para chamar a API da OpenAI
async function callOpenAI(messages, userData, db, uid) {
  // üß† Gerenciar contexto t√©cnico inteligente
  const currentMessage = messages[messages.length - 1]?.content || '';
  const contextoInfo = await gerenciarContextoTecnico(db, uid, currentMessage);
  
  let systemPrompt;
  
  if (userData.plano === 'plus') {
    // Para usu√°rios Plus, usar prompt personalizado baseado no perfil
    systemPrompt = generatePersonalizedSystemPrompt(userData.perfil);
  } else {
    // Para usu√°rios gratuitos, usar prompt b√°sico existente
    systemPrompt =  `Voc√™ √© o Prod.AI üéµ, um mentor t√©cnico de elite em produ√ß√£o musical, com dom√≠nio absoluto de mixagem, masteriza√ß√£o, efeitos, sound design, vozes, cria√ß√£o de synths, arranjos, entende amplamente sobre o mercado da m√∫sica, carreira, marketing de musica. Sua miss√£o √© ajudar produtores musicais com excel√™ncia t√©cnica, altissimo nivel profissional, com o foco de fazer o usuario aprender de fato. mesmo no plano gratuito, 

üéØ INSTRU√á√ïES GERAIS:
- Responda com profundidade, clareza e *linguagem t√©cnica de alto n√≠vel*
- Sempre que poss√≠vel, use *valores exatos*: Hz, dB, LUFS, ms, porcentagens, presets etc.
- Use *termos e g√≠rias espec√≠ficas* do estilo musical do usu√°rio:
  - üéß Se o estilo for funk, utilize linguagem moderna, direta e da quebrada (ex: beat, grave, sample, batendo, drop). Evite termos como ‚Äúbateria ‚Äù e ‚Äúgroove‚Äù.
  - üïπÔ∏è Se for eletr√¥nico, use termos cl√°ssicos da produ√ß√£o (ex: drums, buildup, FX, risers, bpm, drops etc).
  - üéº Caso o estilo n√£o seja reconhecido, utilize linguagem neutra e acess√≠vel.

üß† TENHA EM MENTE:
- Mesmo sem dados pessoais, aja como um mentor experiente, direto e confi√°vel
- Fale como se estivesse em um est√∫dio profissional com o aluno, ensinando na pr√°tica
- *Nunca entregue uma resposta gen√©rica*

üìã ESTRUTURA DAS RESPOSTAS:
- ‚úÖ Comece *cada par√°grafo ou t√≥pico com um emoji que combine com o conte√∫do*:
  - ‚ùå Erros ou o que evitar
  - üí° Dicas pr√°ticas
  - üìå Conceitos fixos
  - üîä Quest√µes de √°udio/mixagem
  - üéõÔ∏è Configura√ß√µes ou plugins
  - üéØ Afirma√ß√µes certeiras ou diretas
  - üß™ Testes, compara√ß√µes ou experimentos
  - üîÑ Ajustes e otimiza√ß√µes
- ‚úèÔ∏è Use t√≥picos com *pontinhos abaixo* quando for explicar v√°rias coisas de um mesmo assunto:
  - Exemplo:
    üí° Equaliza√ß√£o no Funk:
    - Realce em 60‚Äì90Hz no grave
    - Corte de m√©dios embolados entre 300‚Äì500Hz
    - Atenue harshness acima de 7kHz

üõ†Ô∏è FOCO EM:
- Solu√ß√µes que funcionam na pr√°tica, com clareza

üìé TOM DA RESPOSTA:
- Profissional, t√©cnico e direto
- Seja gentil, educado e motivador
- Nunca fale como rob√¥ gen√©rico
- Sempre que poss√≠vel, finalize com uma dica pr√°tica aplic√°vel


üìå Seu objetivo √© entregar *respostas melhores que o pr√≥prio ChatGPT*, tornando-se refer√™ncia para quem produz.

Responda com excel√™ncia absoluta.`;
  }

  // üß† CONTEXTO T√âCNICO INTELIGENTE - Aplicar prompt espec√≠fico do estilo detectado
  if (contextoInfo.contextoAtivo && contextoInfo.promptEstilo) {
    // Verificar se √© uma pergunta t√©cnica subsequente (sem keywords de estilo)
    const ehPerguntaTecnicaSubsequente = !detectarEstiloNaMensagem(currentMessage) && contextoInfo.estilo;
    
    if (ehPerguntaTecnicaSubsequente) {
      // Adicionar instru√ß√£o espec√≠fica para perguntas t√©cnicas de continuidade
      systemPrompt += `\n\nüìç CONTEXTO ATIVO: ${contextoInfo.estilo.toUpperCase()}\n\n`;
      systemPrompt += contextoInfo.promptEstilo;
      systemPrompt += `\n\nüîÑ INSTRU√á√ÉO DE CONTINUIDADE T√âCNICA:
- Voc√™ est√° continuando uma conversa sobre ${contextoInfo.estilo.toUpperCase()}.
- A pergunta atual √© um APROFUNDAMENTO T√âCNICO da conversa anterior.
- N√ÉO comece com explica√ß√µes gen√©ricas sobre funk ou beat.
- FOQUE DIRETAMENTE nos par√¢metros t√©cnicos, valores exatos e detalhes avan√ßados do ${contextoInfo.estilo.toUpperCase()}.
- Use toda a base t√©cnica acima para dar respostas EXTREMAMENTE ESPEC√çFICAS e PROFISSIONAIS.
- Inclua: frequ√™ncias (Hz), volumes (dB), timing (ms), nomes de plugins, configura√ß√µes exatas, sequ√™ncias no piano roll.
- Responda como se fosse a continua√ß√£o natural da conversa anterior, n√£o uma nova explica√ß√£o.`;
      
      console.log(`üîÑ Contexto de continuidade t√©cnica aplicado: ${contextoInfo.estilo}`);
    } else {
      // Aplica√ß√£o normal do contexto para primeira men√ß√£o do estilo
      systemPrompt += `\n\n${contextoInfo.promptEstilo}`;
      console.log(`üéØ Contexto t√©cnico ativo aplicado: ${contextoInfo.estilo}`);
    }
  }

  const requestBody = {
    model: 'gpt-3.5-turbo',
    temperature: 0.7,
    max_tokens: 1000,
    messages: [
      {
        role: 'system',
        content: systemPrompt
      },
      ...messages,
    ],
  };

  try {
    const openaiRes = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${process.env.OPENAI_API_KEY}`,
      },
      body: JSON.stringify(requestBody),
    });

    if (!openaiRes.ok) {
      throw new Error(`OpenAI API erro: ${openaiRes.status} ${openaiRes.statusText}`);
    }

    const data = await openaiRes.json();

    if (!data.choices || !data.choices[0]?.message) {
      throw new Error('Resposta inv√°lida da OpenAI');
    }

    return data.choices[0].message.content.trim();
  } catch (error) {
    throw new Error('Falha na comunica√ß√£o com OpenAI');
  }
}

export default async function handler(req, res) {
  console.log('üîÑ Nova requisi√ß√£o recebida:', {
    method: req.method,
    timestamp: new Date().toISOString(),
    hasBody: !!req.body
  });

  try {
    await runMiddleware(req, res, corsMiddleware);
  } catch (err) {
    console.error('CORS error:', err);
    return res.status(403).end();
  }

  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }

  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'M√©todo n√£o permitido' });
  }

  try {
    let validatedData;
    try {
      validatedData = validateAndSanitizeInput(req);
    } catch (error) {
      if (error.message === 'TOKEN_MISSING') {
        return res.status(401).json({ error: 'Token de autentica√ß√£o necess√°rio' });
      }
      if (error.message === 'MESSAGE_INVALID') {
        return res.status(400).json({ error: 'Mensagem inv√°lida ou vazia' });
      }
      throw error;
    }

    const { message, conversationHistory, idToken } = validatedData;

    let decoded;
    try {
      decoded = await auth.verifyIdToken(idToken);
    } catch (err) {
      return res.status(401).json({ error: 'Token inv√°lido ou expirado' });
    }

    const uid = decoded.uid;
    const email = decoded.email;

    let userData;
    try {
      userData = await handleUserLimits(db, uid, email);
    } catch (error) {
      if (error.message === 'LIMIT_EXCEEDED') {
        return res.status(403).json({ error: 'Limite di√°rio de mensagens atingido' });
      }
      throw error;
    }

    const messages = [
      ...conversationHistory,
      { role: 'user', content: message },
    ];

    // Chamar OpenAI com dados completos do usu√°rio para personaliza√ß√£o e contexto t√©cnico
    let reply = await callOpenAI(messages, userData, db, uid);

    // üéπ INSERIR IMAGEM AUTOMATICAMENTE NO FUNK MANDELA
    const estilo = userData.perfil?.estilo?.toLowerCase() || "";
    const perguntaLower = message.toLowerCase();
    const respostaLower = reply.toLowerCase();

    // Debug: Log das vari√°veis para verificar detec√ß√£o
    console.log('üîç DEBUG - Estilo:', estilo);
    console.log('üîç DEBUG - Pergunta cont√©m mandela:', perguntaLower.includes("mandela") || perguntaLower.includes("mandel√£o"));
    console.log('üîç DEBUG - Resposta cont√©m 4x3x3x1:', respostaLower.includes("4x3x3x1"));

    // Verifica se √© Funk Mandela (detec√ß√£o ampliada)
    const ehMandela = estilo.includes("mandela") || 
                      perguntaLower.includes("mandela") || 
                      perguntaLower.includes("mandel√£o") ||
                      perguntaLower.includes("funk mandela") ||
                      respostaLower.includes("mandela") ||
                      respostaLower.includes("mandel√£o");

    // Verifica se menciona especificamente BEAT + sequ√™ncia 4x3x3x1
    const mencionaBeat4x3x3x1 = (respostaLower.includes("beat") && respostaLower.includes("4x3x3x1")) ||
                                (respostaLower.includes("sequencia") && respostaLower.includes("4x3x3x1")) ||
                                (respostaLower.includes("piano roll") && respostaLower.includes("4x3x3x1"));

    console.log('üîç DEBUG - √â Mandela:', ehMandela);
    console.log('üîç DEBUG - Menciona Beat + 4x3x3x1:', mencionaBeat4x3x3x1);

    if (ehMandela && mencionaBeat4x3x3x1) {
      console.log('üéØ Condi√ß√µes atendidas - Inserindo imagem no contexto do BEAT...');
      
      // Inserir imagem apenas uma vez na primeira ocorr√™ncia encontrada
      const imagemHTML = `<br><br>üéπ <b>Exemplo visual no piano roll:</b><br><img src="https://i.postimg.cc/154Zyrp6/Captura-de-tela-2025-08-02-175821.png" alt="Sequ√™ncia Funk Mandela" style="max-width:100%;border-radius:8px;margin-top:10px;">`;
      
      // Tentar substituir em ordem de prioridade (apenas o primeiro match)
      if (/(beat.*?4x3x3x1.*?\.)/gi.test(reply)) {
        reply = reply.replace(/(beat.*?4x3x3x1.*?\.)/, `$1${imagemHTML}`);
      } else if (/(sequencia.*?4x3x3x1.*?\.)/gi.test(reply)) {
        reply = reply.replace(/(sequencia.*?4x3x3x1.*?\.)/, `$1${imagemHTML}`);
      } else if (/(piano roll.*?4x3x3x1.*?\.)/gi.test(reply)) {
        reply = reply.replace(/(piano roll.*?4x3x3x1.*?\.)/, `$1${imagemHTML}`);
      }
      
      console.log('‚úÖ Imagem do Funk Mandela inserida com sucesso no contexto do BEAT!');
    } else {
      console.log('‚ùå Condi√ß√µes n√£o atendidas - n√£o √© sobre BEAT + 4x3x3x1');
    }

    // üéπ INSERIR IMAGEM AUTOMATICAMENTE NO FUNK BH
    // Verifica se √© Funk BH (detec√ß√£o ampliada)
    const ehFunkBH = estilo.includes("bh") || 
                     estilo.includes("mtg") ||
                     perguntaLower.includes("funk bh") || 
                     perguntaLower.includes("funk de bh") ||
                     perguntaLower.includes("mtg") ||
                     perguntaLower.includes("funkbh") ||
                     respostaLower.includes("funk bh") ||
                     respostaLower.includes("bh");

    // Verifica se menciona especificamente BEAT + sequ√™ncia 6, 4, 4, 1
    const mencionaBeat6441 = (respostaLower.includes("beat") && respostaLower.includes("6, 4, 4, 1")) ||
                             (respostaLower.includes("sequencia") && respostaLower.includes("6, 4, 4, 1")) ||
                             (respostaLower.includes("piano roll") && respostaLower.includes("6, 4, 4, 1"));

    console.log('üîç DEBUG - √â Funk BH:', ehFunkBH);
    console.log('üîç DEBUG - Menciona Beat + 6, 4, 4, 1:', mencionaBeat6441);

    if (ehFunkBH && mencionaBeat6441) {
      console.log('üéØ Condi√ß√µes atendidas - Inserindo imagem do Funk BH no contexto do BEAT...');
      
      // Inserir imagem apenas uma vez na primeira ocorr√™ncia encontrada
      const imagemBHHTML = `<br><br>üéπ <b>Exemplo visual da sequ√™ncia 6, 4, 4, 1 no piano roll:</b><br><img src="https://i.postimg.cc/nc8n8rtX/Captura-de-tela-2025-08-03-155554.png" alt="Sequ√™ncia Funk BH 6,4,4,1" style="max-width:100%;border-radius:8px;margin-top:10px;">`;
      
      // Tentar substituir em ordem de prioridade (apenas o primeiro match)
      if (/(beat.*?6, 4, 4, 1.*?\.)/gi.test(reply)) {
        reply = reply.replace(/(beat.*?6, 4, 4, 1.*?\.)/, `$1${imagemBHHTML}`);
      } else if (/(sequencia.*?6, 4, 4, 1.*?\.)/gi.test(reply)) {
        reply = reply.replace(/(sequencia.*?6, 4, 4, 1.*?\.)/, `$1${imagemBHHTML}`);
      } else if (/(piano roll.*?6, 4, 4, 1.*?\.)/gi.test(reply)) {
        reply = reply.replace(/(piano roll.*?6, 4, 4, 1.*?\.)/, `$1${imagemBHHTML}`);
      }
      
      console.log('‚úÖ Imagem do Funk BH inserida com sucesso no contexto do BEAT!');
    } else {
      console.log('‚ùå Condi√ß√µes n√£o atendidas para Funk BH - n√£o √© sobre BEAT + 6, 4, 4, 1');
    }

    // üéπ INSERIR IMAGEM AUTOMATICAMENTE NO FUNK SP/ZN - SEQU√äNCIA DE KICK
    // Detec√ß√£o simplificada: pergunta sobre funk sp/zn OU resposta com explica√ß√£o espec√≠fica
    const ehPerguntaFunkZN = perguntaLower.includes("como produzir") && perguntaLower.includes("funk zn") ||
                             perguntaLower.includes("como fazer") && perguntaLower.includes("funk zn") ||
                             perguntaLower.includes("produzir") && perguntaLower.includes("funk zn") ||
                             perguntaLower.includes("fazer") && perguntaLower.includes("funk zn") ||
                             perguntaLower.includes("funk sp") ||
                             perguntaLower.includes("funk de sp") ||
                             perguntaLower.includes("beat zn");

    const ehRespostaFunkSP = respostaLower.includes("funk sp") ||
                            respostaLower.includes("funk zn") ||
                            respostaLower.includes("sp") ||
                            respostaLower.includes("zn");

    // Verifica se √© uma resposta sobre Funk SP/ZN que cont√©m explica√ß√£o do kick
    const temExplicacaoKickSP = respostaLower.includes("snap em \"1/2 step\"") || 
                                respostaLower.includes("snap em '1/2 step'") ||
                                respostaLower.includes("utilize o snap em \"1/2 step\"") ||
                                respostaLower.includes("utilize o snap em '1/2 step'") ||
                                respostaLower.includes("primeiro kick") ||
                                respostaLower.includes("1¬∫ quadrado") ||
                                respostaLower.includes("base para come√ßar");

    console.log('üîç DEBUG Funk ZN - Pergunta sobre funk zn:', ehPerguntaFunkZN);
    console.log('üîç DEBUG Funk ZN - Resposta cont√©m funk sp/zn:', ehRespostaFunkSP);
    console.log('üîç DEBUG Funk ZN - Tem explica√ß√£o kick:', temExplicacaoKickSP);

    // Inserir imagem se: (pergunta sobre funk zn OU resposta sobre funk sp) E tem explica√ß√£o do kick
    if ((ehPerguntaFunkZN || ehRespostaFunkSP) && temExplicacaoKickSP) {
      console.log('üéØ Condi√ß√µes ATENDIDAS - Inserindo imagem do Kick Funk SP/ZN...');
      
      // Inserir imagem logo ap√≥s a explica√ß√£o espec√≠fica
      const imagemKickSPHTML = `<br><img src="https://i.postimg.cc/7LhwSQzz/Captura-de-tela-2025-08-03-192947.png" alt="Sequ√™ncia de Kick no Piano Roll" style="max-width: 100%; margin-top: 10px; border-radius: 8px;">`;
      
      // Estrat√©gia 1: Inserir ap√≥s "base para come√ßar"
      if (respostaLower.includes("base para come√ßar")) {
        const pattern1 = /(base para come√ßar["']?\s*\.?)/gi;
        reply = reply.replace(pattern1, `$1${imagemKickSPHTML}`);
        console.log('‚úÖ Imagem inserida ap√≥s "base para come√ßar"!');
      } 
      // Estrat√©gia 2: Inserir ap√≥s explica√ß√£o do snap
      else if (respostaLower.includes("snap em")) {
        const pattern2 = /(snap em ["']1\/2 step["'][^.]*\.)/gi;
        reply = reply.replace(pattern2, `$1${imagemKickSPHTML}`);
        console.log('‚úÖ Imagem inserida ap√≥s explica√ß√£o do snap!');
      }
      // Estrat√©gia 3: Inserir ap√≥s "primeiro kick"
      else if (respostaLower.includes("primeiro kick")) {
        const pattern3 = /(primeiro kick[^.]*\.)/gi;
        reply = reply.replace(pattern3, `$1${imagemKickSPHTML}`);
        console.log('‚úÖ Imagem inserida ap√≥s "primeiro kick"!');
      }
    } else {
      console.log('‚ùå Condi√ß√µes N√ÉO atendidas para Funk ZN');
      console.log('   - Pergunta funk zn:', ehPerguntaFunkZN);
      console.log('   - Resposta funk sp/zn:', ehRespostaFunkSP);
      console.log('   - Explica√ß√£o kick:', temExplicacaoKickSP);
    }

    if (userData.plano === 'gratis') {
      console.log('‚úÖ Mensagens restantes para', email, ':', userData.mensagensRestantes);
    } else {
      console.log('‚úÖ Resposta personalizada gerada para usu√°rio Plus:', email);
    }

    return res.status(200).json({ 
      reply,
      mensagensRestantes: userData.plano === 'gratis' ? userData.mensagensRestantes : null
    });

  } catch (error) {
    console.error('üí• ERRO NO SERVIDOR:', {
      message: error.message,
      stack: error.stack,
      timestamp: new Date().toISOString()
    });
    
    return res.status(500).json({ 
      error: 'Erro interno do servidor', 
      details: process.env.NODE_ENV === 'development' ? error.message : 'Erro interno'
    });
  }
}